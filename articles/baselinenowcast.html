<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting Started with baselinenowcast • baselinenowcast</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with baselinenowcast">
<meta name="description" content="A quick start example demonstrating use of baselinenowcast">
<meta property="og:description" content="A quick start example demonstrating use of baselinenowcast">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">baselinenowcast</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.1000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/baselinenowcast.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/baselinenowcast.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/model_definition.html">Mathematical model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epinowcast/baselinenowcast/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting Started with baselinenowcast</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epinowcast/baselinenowcast/blob/main/vignettes/baselinenowcast.Rmd" class="external-link"><code>vignettes/baselinenowcast.Rmd</code></a></small>
      <div class="d-none name"><code>baselinenowcast.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="introduction">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Incomplete reporting of epidemiological data at recent times can result in case
count data that is right-truncated.
Right-truncated case counts can be misleading to interpret at face-value, as
they will typically show a decline in the number of reported observations in
the most recent time points.
These are the time points where the highest proportion of the data has yet to
be observed in the dataset.</p>
<p>The imputation of the cases that will eventually be observed up until the
current time is referred to as a nowcast.</p>
<p>A number of methods have been developed to nowcast epidemiological case count
data.</p>
<p>The purpose of <code>baselinenowcast</code> is to provide a nowcast computed directly from
the most recent observations to estimate a delay distribution empirically, and
apply that to the partially observed data to generate a nowcast.</p>
<p>In the below section, we will describe an example of a nowcasting problem, and
demonstrate how to use <code>baselinenowcast</code> to estimate a delay distribution from
the data and apply that estimate to generate a probabilistic nowcast.</p>
</div>
<div class="section level2" number="2">
<h2 id="packages">
<span class="header-section-number">2</span> Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h2>
<p>As well as the <code>baselinenowcast</code> package this vignette also uses <code>epinowcast</code>,
<code>ggplot2</code>, and <code>dplyr</code>.
The installation of <code>epinowcast</code> is not required for using the package,
however, its pre and post-processing functions provide a lot of the data
wrangling needed to set up the nowcasting problem.
We note that no components of the vignette require installing <code>CmdStan</code>,
which is a downstream dependency of <code>epinowcast</code>.
We will just be using the <code>R</code> components of <code>epinowcast</code>, which can be
installed using the example lines of code below, so there is no need to
additionally install <code>CmdStan</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Installing epinowcast</span></span>
<span><span class="co"># install.packages( #nolint</span></span>
<span><span class="co">#  "epinowcast", repos = "https://epinowcast.r-universe.dev" #nolint</span></span>
<span><span class="co"># ) #nolint</span></span>
<span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://baselinenowcast.epinowcast.org">baselinenowcast</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://package.epinowcast.org" class="external-link">epinowcast</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="co"># Set seed for reproducibility</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2" number="3">
<h2 id="data">
<span class="header-section-number">3</span> Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Nowcasting of right-truncated case counts involves the estimation of reporting
delays for recently reported data.
For this, we need case counts indexed both by when they were diagnosed (often
called “reference date”) and by when they were
reported (i.e. when administratively recorded via public health surveillance;
often called “report date”). The difference between the reference date and the
report date is the reporting delay.
For this quick start, we use daily level data from the
<a href="https://github.com/KITmetricslab/hospitalization-nowcast-hub/wiki/Truth-data#role-an-definition-of-the-seven-day-hospitalization-incidence" class="external-link">Robert Koch Institute via the Germany Nowcasting hub</a>.
These data represent hospital admission counts by date of positive test and date
of test report in Germany up to October 1, 2021.</p>
</div>
<div class="section level2" number="4">
<h2 id="filtering-and-plotting-the-data">
<span class="header-section-number">4</span> Filtering and plotting the data<a class="anchor" aria-label="anchor" href="#filtering-and-plotting-the-data"></a>
</h2>
<p>We will filter the data to just look at the national-level data, for all age
groups.
We will pretend that we are making a nowcast as of July 1, 2021, therefore we
will exclude all reference dates and report dates after that date.
<code>germany_covid19_hosp</code> is provided as package data from <code>epinowcast</code>
Let’s start by plotting the sum of the reports at each reference date,
and then compare that to what we will eventually observe as of the final date
in the complete dataset.
The red line shows the cumulative number of confirmed admissions on each report
date, across all delays, using the data available as of July 1, 2021.
It demonstrates the characteristic behaviour of right-truncation.
This is because we have not yet observed the data that will become available
for the longer delays at recent time points.</p>
<p>Our task will be to estimate what the “final” cumulative number of cases
at each reference date, observed as of the “fully observed” data on October
2021.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_long</span> <span class="op">&lt;-</span> <span class="va">germany_covid19_hosp</span> <span class="co"># import data from epinowcast</span></span>
<span><span class="va">data_filtered</span> <span class="op">&lt;-</span> <span class="va">data_long</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="st">"2021-07-01"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span>, <span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span>,</span>
<span>    <span class="va">report_date</span> <span class="op">==</span> <span class="st">"2021-07-01"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">data_filtered_max</span> <span class="op">&lt;-</span> <span class="va">data_long</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span>, <span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span>,</span>
<span>    <span class="va">reference_date</span> <span class="op">&lt;=</span> <span class="st">"2021-07-01"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>confirm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">confirm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_filtered</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">data_filtered_max</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">confirm</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing real-time and later observed cases"</span><span class="op">)</span></span></code></pre></div>
<p><img src="baselinenowcast_files/figure-html/plot-the-data-by-reference-date-1.png" width="672"></p>
<p>Here the black line represents the quantity we will evaluate our nowcast
against, the final observed cases, and the red line represents the observed
cases we have observed up until July 1st, 2021.</p>
</div>
<div class="section level2" number="5">
<h2 id="pre-processing">
<span class="header-section-number">5</span> Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing"></a>
</h2>
<p>In order to compute a nowcast for this data, we will need to start by creating
what we call a reporting triangle.
This is a matrix where each row represents one of the time
points being referenced and each column represents the delay, starting from 0 up
until the maximum delay.
The entries represent the number of new cases assigned to that reference
time point with a particular delay, with entries in the bottom right triangle
missing as the data reported with longer delays has yet to be observed for
recent reference times.
The reporting triangle will be used to estimate the delay distribution, or the
proportion of the final number of cases reported on a particular delay.
Since this data is both reported and referenced daily, we will use the time
scale of days to create the reporting triangle, but the delay and the reference
date can have any temporal granularity.</p>
<p>In this example, we will both fit our delay distribution, and apply it to
generate a nowcast matrix using the same data, the national level data from
Germany for all age groups.
However, these components can be separated, so for example, we could use the
national level data for all age groups to estimate a delay distribution, and
then we could apply that elsewhere, for example to the data stratified by
age group and location.
This type of “borrowing” from another training dataset can be really useful
when you have low counts or relatively sparse data, which is likely to be the
case for smaller populations.</p>
<p>In the below sections, we will specify our nowcast date, the maximum delay,
and the number of reference time observations that we want to use to
estimate the delay distribution.
We recommend choosing the maximum delay and number of historical observations
based on an exploratory data analysis, as these specifications will change
significantly depending on the dataset.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_date</span> <span class="op">&lt;-</span> <span class="st">"2021-07-01"</span></span>
<span></span>
<span><span class="co"># Specify the maximum delay, which will determine the length of your delay</span></span>
<span><span class="co"># distribution. Empirical data outside this delay window will not be used for</span></span>
<span><span class="co"># training.</span></span>
<span><span class="va">max_delay</span> <span class="op">&lt;-</span> <span class="fl">40</span></span>
<span></span>
<span><span class="co"># Specify the number of reference times to use to estimate the delay</span></span>
<span><span class="co"># distribution. Note this assumes you want the most recent observations.</span></span>
<span><span class="va">n_history_delay</span> <span class="op">&lt;-</span> <span class="fl">60</span></span></code></pre></div>
<p>Next we will use the <code>epinowcast</code> function, <code><a href="https://package.epinowcast.org/reference/enw_preprocess_data.html" class="external-link">enw_preprocess_data()</a></code> and the
data in the form of a long tidy dataframe indexed by reference date and
report date and filtered to the strata we are interested in, to generate a
reporting triangle.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Noting that this is the only way epinowcast preprocessing would work --</span></span>
<span><span class="co"># return to this later. IDate was throwing errors if we used the dplyr processed</span></span>
<span><span class="co"># observed long above.</span></span>
<span><span class="va">observed_long</span> <span class="op">&lt;-</span> <span class="va">data_long</span><span class="op">[</span><span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span><span class="op">]</span><span class="op">[</span><span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="va">nowcast_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span>include_days <span class="op">=</span> <span class="va">n_history_delay</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">observed_long</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    reference_date location age_group confirm report_date</span></span>
<span><span class="co">##            &lt;IDat&gt;   &lt;fctr&gt;    &lt;fctr&gt;   &lt;int&gt;      &lt;IDat&gt;</span></span>
<span><span class="co">## 1:     2021-05-03       DE       00+     107  2021-05-03</span></span>
<span><span class="co">## 2:     2021-05-04       DE       00+     240  2021-05-04</span></span>
<span><span class="co">## 3:     2021-05-05       DE       00+     245  2021-05-05</span></span>
<span><span class="co">## 4:     2021-05-06       DE       00+     259  2021-05-06</span></span>
<span><span class="co">## 5:     2021-05-07       DE       00+     263  2021-05-07</span></span>
<span><span class="co">## 6:     2021-05-08       DE       00+     189  2021-05-08</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the reporting triangle, adding an additional day because epinowcast</span></span>
<span><span class="co"># we want the max_delay + 1 entries since 0 is a valid delay.</span></span>
<span><span class="va">pobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://package.epinowcast.org/reference/enw_preprocess_data.html" class="external-link">enw_preprocess_data</a></span><span class="op">(</span></span>
<span>  obs <span class="op">=</span> <span class="va">observed_long</span>,</span>
<span>  max_delay <span class="op">=</span> <span class="va">max_delay</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># as we only have one group here we only need referfence_date, delay,</span></span>
<span><span class="co"># and new_confirm</span></span>
<span><span class="va">reporting_triangle_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pobs</span><span class="op">$</span><span class="va">new_confirm</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">reference_date</span>, <span class="va">delay</span>, <span class="va">new_confirm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we now pivot to wide format, dropping the reference_date column, and</span></span>
<span><span class="co"># convert to a matrix</span></span>
<span><span class="co"># this is the format that baselinenowcast expects</span></span>
<span><span class="va">reporting_triangle</span> <span class="op">&lt;-</span> <span class="va">reporting_triangle_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">delay</span>, values_from <span class="op">=</span> <span class="va">new_confirm</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">reporting_triangle</span>, n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</span></span>
<span><span class="co">## [41,] 29 21  2 10  9  6  1  1  1  0  5  2  2  0  4  1  1  1  1  2 NA NA NA NA</span></span>
<span><span class="co">## [42,] 14  7 16  4  0  1  3  0  0  3  2  1  1  1  0  0  2  0  0 NA NA NA NA NA</span></span>
<span><span class="co">## [43,] 12 12  7  0  2  6  1  1  1  1  1  0  0  0  0  0  0  0 NA NA NA NA NA NA</span></span>
<span><span class="co">## [44,] 41 28 10  6  0  0  0  2  1  1  3  0  3  0  0  1  0 NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [45,] 34 18  8  9  1  2  4  5  3  0  1  1  2  2  1  0 NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [46,] 36 16  4  6  2  7  5  0  1  2  1  0  3  2  1 NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [47,] 23  9  4  3  7  6  2  4  4  2  1  1  5  1 NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [48,] 26  7  3  4  3  3  2  3  2  0  0  0  1 NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [49,] 16  7  7  2  1  1  3  0  0  2  1  2 NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [50,]  4 11  5  1  0  2  0  0  0  0  0 NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [51,] 24 18  4  5  2  1  0  0  2  2 NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [52,] 32 15 11  2  0  1  2  0  2 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [53,] 34 17  4  1  0  0  0  1 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [54,] 21 13  2  0  5  2  1 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [55,] 16  4  3  5  3  0 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [56,]  5  6  5  1  3 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [57,]  3  5  2  1 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [58,] 20 11  4 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [59,] 20 17 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [60,] 20 NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">##       24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40</span></span>
<span><span class="co">## [41,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [42,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [43,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [44,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [45,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [46,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [47,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [48,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [49,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [50,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [51,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [52,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [53,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [54,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [55,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [56,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [57,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [58,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [59,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## [60,] NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA NA</span></span></code></pre>
<p>To see what this looks like, we can plot it using <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">triangle_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">reporting_triangle</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">time</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">"V"</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"delay"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">triangle_df</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">time</span>, fill <span class="op">=</span> <span class="va">count</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Reporting triangle"</span>, x <span class="op">=</span> <span class="st">"Delay"</span>, y <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="baselinenowcast_files/figure-html/make-heatmap-reporting-triangle-1.png" width="672"></p>
</div>
<div class="section level2" number="6">
<h2 id="estimate-delay">
<span class="header-section-number">6</span> Estimate delay<a class="anchor" aria-label="anchor" href="#estimate-delay"></a>
</h2>
<p>Now that we have the reporting triangle, we are now ready to pass it in to the
<code>baselinenowcast</code> package to estimate the delay distribution.
We will tell the function the maximum delay and the number of observations we
want to use, though the default will be to use the whole reporting triangle.
If the reporting triangle is too small for the user-specified delays and number
of training observations, the function will throw an error.
We only want to pass in the reporting triangle (for a single group!) to this
function.
If reference date are repeated because the reporting triangle contains multiple
strata, the function will throw an error.</p>
<p>The <code><a href="../reference/get_delay_estimate.html">get_delay_estimate()</a></code> function expects the following inputs:
- <code>reporting_triangle</code>: a matrix with the reporting triangle for a single
strata. Here the rows represent the time points and the columns represent the
observed delays, starting at 0. This can also be a reporting matrix or an
incomplete reporting matrix (so not all elements of the bottom right triangle
need to be missing).
- <code>max_delay</code>: an integer indicating the maximum delay to estimate. This must
be less than or equal to the number of rows in <code>triangle</code> minus 1, since we
assume <code>triangle</code> is indexed at 0.
- <code>n_history_delay</code>: an integer indicating the number of observations by reference
date to use to fit the delay distribution. This must be less than or equal to
the number of rows in <code>triangle</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_delay_estimate.html">get_delay_estimate</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">reporting_triangle</span>,</span>
<span>  max_delay <span class="op">=</span> <span class="va">max_delay</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_history_delay</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  delay <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">delay_pmf</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Cumulative proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of cumulative proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="baselinenowcast_files/figure-html/estimate-delay-1.png" width="672"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">pmf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="baselinenowcast_files/figure-html/estimate-delay-2.png" width="672"></p>
</div>
<div class="section level2" number="7">
<h2 id="apply-delay-to-generate-point-nowcast">
<span class="header-section-number">7</span> Apply delay to generate point nowcast<a class="anchor" aria-label="anchor" href="#apply-delay-to-generate-point-nowcast"></a>
</h2>
<p>The next step in our workflow is to take the estimated delay distribution and
apply it to the partially observed reporting triangle, generating an estimate
of the number of new cases confirmed at each reference date and delay.
This will generate a point estimate of what we can call the reporting square,
which is the complete set of reference dates and delays.
In this case, we will be applying the delay to the same reporting triangle we
used to generate the estimate, but this doesn’t always have to be the case.
The reporting triangle we are applying it to must have the same <code>max_delay</code>
as the delay estimate.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_nowcast_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_delay.html">apply_delay</a></span><span class="op">(</span></span>
<span>  rep_tri_to_nowcast <span class="op">=</span> <span class="va">reporting_triangle</span>,</span>
<span>  delay_pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We’ll make a quick plot to compare the nowcasted confirmed cases through
July 1, 2021, from the observations up until October 1, 2021.
We’ll compare this to the right-truncated data available up until July 1, 2021.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_data</span> <span class="op">&lt;-</span> <span class="va">data_long</span><span class="op">[</span><span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span><span class="op">]</span><span class="op">[</span><span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="st">"2021-10-01"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span></span>
<span>    latest_date <span class="op">=</span> <span class="st">"2021-07-01"</span>,</span>
<span>    include_days <span class="op">=</span> <span class="va">n_history_delay</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    total_confirmed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">confirm</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>nowcast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">point_nowcast_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">summary_data</span> <span class="op">&lt;-</span> <span class="va">observed_long</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>total_confirmed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">confirm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    <span class="co"># Plot the data summed across reporting days as of July 1,2021</span></span>
<span>    data <span class="op">=</span> <span class="va">summary_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">total_confirmed</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">final_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">total_confirmed</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">final_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">nowcast</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkblue"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing real-time, nowcasted, and later observed cases"</span><span class="op">)</span></span></code></pre></div>
<p><img src="baselinenowcast_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Here we can see that our point nowcast slightly overestimates what was
eventually reported (black line), but does a decent overall job of correcting
for the right-truncation observed in the red line (the data prior to the
nowcast).</p>
</div>
<div class="section level2" number="8">
<h2 id="estimate-uncertainty">
<span class="header-section-number">8</span> Estimate uncertainty<a class="anchor" aria-label="anchor" href="#estimate-uncertainty"></a>
</h2>
<p>So far, we’ve demonstrated how to generate a point estimate of a nowcast.
We would like to generate probabilistic nowcasts.
To do so, we will use the error between the observations that we have and what
we would have nowcasted retrospectively. We will assume that the observations
follow a negative binomial observation model, and independently estimate the
dispersion in the negative binomial at each delay <span class="math inline">\(d\)</span>.</p>
<p>The method used to estimate the uncertainty in the nowcast simulates exactly
the iterative process, by generating retrospective reporting
triangles using what would have been available as of the time, and then for
each reporting triangle, estimating a delay distribution and generating
a nowcast.</p>
<p>To do this, we will first generate truncated reporting matrices from the
latest reporting triangle, generate retrospective reporting triangles
by removing observations that wouldn’t have been observed as of the latest time
point, and lastly generate nowcasts from that list of retrospective reporting
triangles.
The function will default to assuming you want to generate
as many retrospective reporting triangles that you will be able to generate
nowcasts from. In this case, the function will return 18 retrospective
reporting triangles, with the smallest one containing 42 rows, all of which
are needed to generate a nowcast of reporting triangle with 41 delay columns.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trunc_rep_mat_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/truncate_triangles.html">truncate_triangles</a></span><span class="op">(</span><span class="va">reporting_triangle</span><span class="op">)</span></span>
<span><span class="va">retro_rep_tri_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_triangles.html">generate_triangles</a></span><span class="op">(</span><span class="va">trunc_rep_mat_list</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/generate_triangles.html">generate_triangles()</a></code> function returns a list of
reporting triangles, in order from the most to least
recent, starting from the most recent. It is not filtered to exclude any
rows that may not ultimately be used to generate the nowcast, which means
that each triangle will have a different number of rows.</p>
<p>Next we will pass this list of reporting triangles to the
<code>generate_nowcasts()</code> alongside the specification of how many observations
to use to estimate the delay</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">retro_pt_nowcast_mat_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_pt_nowcast_mat_list.html">generate_pt_nowcast_mat_list</a></span><span class="op">(</span></span>
<span>  reporting_triangle_list <span class="op">=</span> <span class="va">retro_rep_tri_list</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we will use the list of retrospective reporting triangles to estimate
the uncertainty at each delay <span class="math inline">\(d\)</span></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disp_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_dispersion.html">estimate_dispersion</a></span><span class="op">(</span></span>
<span>  pt_nowcast_mat_list <span class="op">=</span> <span class="va">retro_pt_nowcast_mat_list</span>,</span>
<span>  trunc_rep_mat_list <span class="op">=</span> <span class="va">trunc_rep_mat_list</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2" number="9">
<h2 id="generate-probabilistic-nowcast">
<span class="header-section-number">9</span> Generate probabilistic nowcast<a class="anchor" aria-label="anchor" href="#generate-probabilistic-nowcast"></a>
</h2>
<p>Now that we have estimated the dispersion, we take the point nowcast matrix we
previously generated, <code>point_nowcast_matrix</code>, and generate many draws of the
expected observed values to get a probabilistic nowcast.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_matrix_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_uncertainty.html">add_uncertainty</a></span><span class="op">(</span></span>
<span>  point_nowcast_matrix <span class="op">=</span> <span class="va">point_nowcast_matrix</span>,</span>
<span>  disp <span class="op">=</span> <span class="va">disp_params</span>,</span>
<span>  n_draws <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we will take the list of nowcast matrices and
convert this into a long tidy dataframe, indexed by reference time <code>t</code>,
delay <code>d</code>, and draws.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nowcast_matrix_list_to_df.html">nowcast_matrix_list_to_df</a></span><span class="op">(</span></span>
<span>  nowcast_matrix_list <span class="op">=</span> <span class="va">nowcast_matrix_list</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcast_draws</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   time delay count draw</span></span>
<span><span class="co">## 1    1     1   107    1</span></span>
<span><span class="co">## 2    1     2    76    1</span></span>
<span><span class="co">## 3    1     3    45    1</span></span>
<span><span class="co">## 4    1     4    25    1</span></span>
<span><span class="co">## 5    1     5    23    1</span></span>
<span><span class="co">## 6    1     6    16    1</span></span></code></pre>
<p>The package also provides a helper function, <code><a href="../reference/aggregate_df_by_ref_time.html">aggregate_df_by_ref_time()</a></code>
which converts the draws indexed by <code>t</code> and <code>d</code> to one which contains the sum
over all delays. We can then use this to plot the nowcasts compared to the
data available as of the nowcast date, and the later observed data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_df_by_ref_time.html">aggregate_df_by_ref_time</a></span><span class="op">(</span><span class="va">nowcast_draws</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join with the original data</span></span>
<span><span class="va">final_data</span> <span class="op">&lt;-</span> <span class="va">data_long</span><span class="op">[</span><span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span><span class="op">]</span><span class="op">[</span><span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_report_dates.html" class="external-link">enw_filter_report_dates</a></span><span class="op">(</span>latest_date <span class="op">=</span> <span class="st">"2021-10-01"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://package.epinowcast.org/reference/enw_filter_reference_dates.html" class="external-link">enw_filter_reference_dates</a></span><span class="op">(</span></span>
<span>    latest_date <span class="op">=</span> <span class="st">"2021-07-01"</span>,</span>
<span>    include_days <span class="op">=</span> <span class="va">n_history_delay</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    final_confirmed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">confirm</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">original_data</span> <span class="op">&lt;-</span> <span class="va">observed_long</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>original_confirmed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">confirm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  reference_date <span class="op">=</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>      from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">original_data</span><span class="op">$</span><span class="va">reference_date</span><span class="op">)</span>,</span>
<span>      to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">original_data</span><span class="op">$</span><span class="va">reference_date</span><span class="op">)</span>,</span>
<span>      by <span class="op">=</span> <span class="st">"day"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sampled_draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">summary_nowcast</span><span class="op">$</span><span class="va">draw</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">summary_nowcast_w_data</span> <span class="op">&lt;-</span> <span class="va">summary_nowcast</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">time_df</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"time"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">original_data</span>, by <span class="op">=</span> <span class="st">"reference_date"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">final_data</span>, by <span class="op">=</span> <span class="st">"reference_date"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Filter to a set of draws for plotting + zoom in on nowcast period</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">draw</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">sampled_draws</span>,</span>
<span>    <span class="va">reference_date</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="va">max_delay</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">summary_nowcast_w_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">total_count</span>, group <span class="op">=</span> <span class="va">draw</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">"gray"</span>, linewidth <span class="op">=</span> <span class="fl">0.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">original_confirmed</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">final_confirmed</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hospital admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparison of admissions as of the nowcast date, later observed counts, \n and probabilistic nowcasted counts"</span><span class="op">)</span> <span class="co"># nolint</span></span></code></pre></div>
<p><img src="baselinenowcast_files/figure-html/summarise-by-ref-time-1.png" width="672"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kaitlyn Johnson, <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>, Johannes Bracher, Sebastian Funk.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
