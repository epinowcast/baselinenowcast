<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mathematical methods for `baselinenowcast` • baselinenowcast</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mathematical methods for `baselinenowcast`">
<meta name="description" content="Description of mathematical methods used in the package">
<meta property="og:description" content="Description of mathematical methods used in the package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">baselinenowcast</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.1000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/baselinenowcast.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/baselinenowcast.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/model_definition.html">Mathematical model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epinowcast/baselinenowcast/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mathematical methods for `baselinenowcast`</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epinowcast/baselinenowcast/blob/main/vignettes/model_definition.Rmd" class="external-link"><code>vignettes/model_definition.Rmd</code></a></small>
      <div class="d-none name"><code>model_definition.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="overview">
<span class="header-section-number">1</span> Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The method to generate nowcasts use a multiplicative model.
This multiplicative model works by iteratively “filling in” the reporting triangle starting from the bottom left, and moving column by column from left to right until the bottom right of the triangle is filled in.</p>
<p><img src="../reference/figures/schematic_fig.png"></p>
<p>Figure 1. Schematic figure demonstrating the iterative generation of nowcasts from a reporting triangle. In this case, the values being estimated are <span class="math inline">\(x_{t=6, d = 2}\)</span> and <span class="math inline">\(x_{t=5, d= 2}\)</span> assuming that we have already iteratively estimated <span class="math inline">\(x_{t=6, d= 1}\)</span>. The dotted dashed lines around observations <span class="math inline">\(x_{t,d}\)</span> indicated estimates that have been imputed, the dashed lines indicates observations <span class="math inline">\(x_{t,d}\)</span> that have not yet been observed or imputed, and the solid lines indicate observations that have been observed.</p>
<p>The method requires at least one observation, at delay <span class="math inline">\(d=0\)</span> for the most recent reference date, located at the bottom of the reporting triangle in Fig 1 above. The method assumes that the values at each delay <span class="math inline">\(d\)</span> column will be the same proportion of the values previously reported. To fill in the missing values for each column <span class="math inline">\(d\)</span>, we sum over the rectangle of completely observed reference dates for all <span class="math inline">\(d-1\)</span> columns (block top left) and sum over the column of completely observed reference dates for all of the entries in column <span class="math inline">\(d\)</span> (block left). The ratio of these two sums is assumed to be the same in the missing entries in column <span class="math inline">\(d\)</span>, so we use the entries observed up to <span class="math inline">\(d-1\)</span> for each incomplete reference date (block bottom left), and scale by this ratio to get the missing entries in column <span class="math inline">\(d\)</span>. This process is repeated for each delay from <span class="math inline">\(d\)</span> to the maximum delay <span class="math inline">\(D\)</span>. At each iteration an additional reference date entry is computed as the delay <span class="math inline">\(d\)</span> increases.</p>
</div>
<div class="section level2" number="2">
<h2 id="mathematical-model">
<span class="header-section-number">2</span> Mathematical model<a class="anchor" aria-label="anchor" href="#mathematical-model"></a>
</h2>
<p>The following describes the estimate of the delay distribution, the generation of the point nowcast, and the estimate of the observation error, for a partially observed or complete reporting triangle.
The method itself is time-unit agnostic, which means it can be used to generate nowcasts for any temporal granularity in the reporting and reference of data.
In the case where the temporal granularity of the reporting differs from the referencing, e.g.
weekly releases of daily data, pre-processing will need to be done so that the units of the delays <span class="math inline">\(d\)</span> and the units of the reference time <span class="math inline">\(t\)</span> are the same (e.g. by filling in 0s for all the days of the week that no data is reported).
This method is based on the method described by <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1011394" class="external-link">Wolffram et al. 2023</a>.</p>
<div class="section level3" number="2.1">
<h3 id="notation">
<span class="header-section-number">2.1</span> Notation<a class="anchor" aria-label="anchor" href="#notation"></a>
</h3>
<p>We denote <span class="math inline">\(X_{t,d}, d = 0, .., D\)</span> as the number of cases occurring on time <span class="math inline">\(t\)</span> which appear in the dataset with a delay of <span class="math inline">\(d\)</span>. For example, a delay <span class="math inline">\(d = 0\)</span> means that a case occurring on day <span class="math inline">\(t\)</span> arrived in the dataset on day <span class="math inline">\(t\)</span>, or on what is considered to be the first possible report date in practice. We only consider cases reporting within a maximum delay <span class="math inline">\(D\)</span>. The number of cases reporting for time <span class="math inline">\(t\)</span> with a delay of at most <span class="math inline">\(d\)</span> can be written as:</p>
<p><span class="math display">\[X_{t, \le d} = \sum_{i=0}^d X_{t,i} \]</span></p>
<p>Such that <span class="math inline">\(X_t = X_{t, \le D}\)</span> is the “final” number of reported cases on time <span class="math inline">\(t\)</span>. Conversely, for <span class="math inline">\(d &lt; D\)</span></p>
<p><span class="math display">\[X_{t,&gt;d} = \sum_{i = d+1} ^{D} X_{t,i}\]</span></p>
<p>is the number of cases still missing after <span class="math inline">\(d\)</span> delay.
We refer to <span class="math inline">\(X_t\)</span> to describe a random variable, <span class="math inline">\(x_t\)</span> for the corresponding observation, and <span class="math inline">\(\hat{x}_t\)</span> for an estimated/imputed value.
We refer to the matrix of <span class="math inline">\(x\)</span> available at a given data release time <span class="math inline">\(t^*\)</span> , as the reporting triangle. Here, all <span class="math inline">\(t+d&gt;t^*\)</span> have yet to be observed.</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th></th>
<th><span class="math inline">\(d = 0\)</span></th>
<th><span class="math inline">\(d = 1\)</span></th>
<th><span class="math inline">\(d=2\)</span></th>
<th><span class="math inline">\(...\)</span></th>
<th><span class="math inline">\(d= D-1\)</span></th>
<th><span class="math inline">\(d= D\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(t=1\)</span></td>
<td><span class="math inline">\(x_{1,0}\)</span></td>
<td><span class="math inline">\(x_{1,1}\)</span></td>
<td><span class="math inline">\(x_{1,2}\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(x_{1,D-1}\)</span></td>
<td><span class="math inline">\(x_{1, D}\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(t=2\)</span></td>
<td><span class="math inline">\(x_{2,0}\)</span></td>
<td><span class="math inline">\(x_{2,1}\)</span></td>
<td><span class="math inline">\(x_{2,2}\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(x_{2,D-1}\)</span></td>
<td><span class="math inline">\(x_{2, D}\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(t=3\)</span></td>
<td><span class="math inline">\(x_{3,0}\)</span></td>
<td><span class="math inline">\(x_{3,1}\)</span></td>
<td><span class="math inline">\(x_{3,2}\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(x_{3,D-1}\)</span></td>
<td><span class="math inline">\(x_{3, D}\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(...\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(t=t^*-1\)</span></td>
<td><span class="math inline">\(x_{t^*-1,0}\)</span></td>
<td><span class="math inline">\(x_{t^*-1,1}\)</span></td>
<td><span class="math inline">\(x_{t^*-1,,2}\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(x_{t^*-1,,D-1}\)</span></td>
<td><span class="math inline">\(x_{t^*-1,D}\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(t=t^*\)</span></td>
<td><span class="math inline">\(x_{t^*,0}\)</span></td>
<td><span class="math inline">\(x_{t^*,1}\)</span></td>
<td><span class="math inline">\(x_{t^*,2}\)</span></td>
<td><span class="math inline">\(...\)</span></td>
<td><span class="math inline">\(x_{t^*,D-1}\)</span></td>
<td><span class="math inline">\(x_{t^*, D}\)</span></td>
</tr>
</tbody>
</table>
</div>
<div class="section level3" number="2.2">
<h3 id="point-estimate-of-the-delay-distribution">
<span class="header-section-number">2.2</span> Point estimate of the delay distribution<a class="anchor" aria-label="anchor" href="#point-estimate-of-the-delay-distribution"></a>
</h3>
<p>We use the entire reporting triangle to compute an empirical estimate of the delay distribution, <span class="math inline">\(\pi(d)\)</span>.
Another way to think about this as a probability distribution describing the probability that a case incident at reference time <span class="math inline">\(t\)</span> appears in the dataset with delay <span class="math inline">\(d\)</span> (so at time <span class="math inline">\(t + d\)</span>). We refer to the realized empirical estimate of the delay distribution from a reporting triangle as <span class="math inline">\(\pi(d)\)</span>.
The delay distribution, <span class="math inline">\(\pi(d)\)</span> can be estimated directly from the completed reporting matrix <span class="math inline">\(X\)</span></p>
<p><span class="math display">\[
\pi(d)= \frac{\sum_{t=1}^{t=t^*} X_{t,d}}{\sum_{d=0}^{D} \sum_{t=1}^{t=t^*} X_{t,d}}
\]</span></p>
<p>Where the numerator is the sum of all the observations across reference times <span class="math inline">\(t\)</span> for a particular delay <span class="math inline">\(d\)</span>, and the denominator is the sum across all reference times <span class="math inline">\(t\)</span> and delays <span class="math inline">\(d\)</span>.</p>
<p>In the special case when the reporting triangle is fully observed, i.e. the time the estimate is made, <span class="math inline">\(t'\)</span>, is greater than the data release time plus the maximum delay (<span class="math inline">\(t' \ge t^* + D\)</span>), <span class="math inline">\(\hat{\pi}_d\)</span> can be computed directly.</p>
</div>
<div class="section level3" number="2.3">
<h3 id="point-nowcast-from-incomplete-reporting-matrix">
<span class="header-section-number">2.3</span> Point nowcast from incomplete reporting matrix<a class="anchor" aria-label="anchor" href="#point-nowcast-from-incomplete-reporting-matrix"></a>
</h3>
<p>In the case where there are partial observations, in order to properly weight the denominator with the missing delays, we have to first impute the cases <span class="math inline">\(\hat{x}_{t,d}\)</span> for all instances where <span class="math inline">\(t+d &gt; t^*\)</span>. This amounts to computing the point nowcast from the partial reporting triangle.</p>
<p>To do so, we start by defining <span class="math inline">\(\theta_d\)</span>, which is the factor by which the cases on delay <span class="math inline">\(d\)</span> compare to the total cases through delay <span class="math inline">\(d-1\)</span>, obtained from <span class="math inline">\(N\)</span> preceding rows of the triangle. In practice, <span class="math inline">\(N \ge D\)</span>, with any <span class="math inline">\(N &gt; D\)</span> representing the number of completed observations used to inform the estimate</p>
<p><span class="math display">\[
\hat{\theta}_d(t^*) = \frac{\sum_{i=1}^{N} x_{t^*-i+d, d}}{\sum_{d=1}^{d-1} \sum_{i=1}^{N} x_{t^*-i+d,d}}
\]</span></p>
<p>This amounts to taking the sum of the elements in column <span class="math inline">\(d\)</span> up until time <span class="math inline">\(t*-d\)</span> and dividing by the sum over all the elements to the left of column <span class="math inline">\(d\)</span> up until time <span class="math inline">\(t*-d\)</span>, referred to as “block top” and “block top left”, respectively, in the Figure 1.</p>
<p>This factor is then used to compute the expected values for all the missing rows with delay <span class="math inline">\(d\)</span> as:</p>
<p><span class="math display">\[
\hat{x}_{t,d} = \hat{\theta_d}(t^*) \times \sum_{t=t^*-d}^{t^*} x_{t,d-1}
\]</span></p>
<p>This amounts to effectively taking the sum across the columns in the bottom left (“block bottom left” in the Figure 1) of the matrix up until column <span class="math inline">\(d\)</span> and multiplying by the factor to estimate the value of <span class="math inline">\(x_{t,d}\)</span> in each row.
This process is repeated iteratively, from bottom left to top right, to impute the bottom right triangle of the reporting matrix for each time <span class="math inline">\(t\)</span> and delay <span class="math inline">\(d\)</span> when <span class="math inline">\(t+d&gt;t^*\)</span>. The combination of the imputed and observed reporting matrix is then used to compute the delay distribution <span class="math inline">\(\hat{\pi}(d)\)</span> as described above.
The factor, <span class="math inline">\(\theta_d\)</span> can only be computed for delays greater than 0, which effectively means that a row of the reporting triangle without any observations, can not be imputed as the process works iteratively. Therefore, the reporting matrix must have at least an entry (though it can be 0) for <span class="math inline">\(x_{t*,d=0}\)</span> to compute a nowcast for <span class="math inline">\(t^*\)</span>. We will describe the method for estimating nowcasts for zero-valued counts below.
The method described above uses the incomplete reporting triangle to iteratively compute a point nowcast. We can also use the delay distribution <span class="math inline">\(\hat{\pi(d)}\)</span> directly to compute a point nowcast, which can be useful if, for example, the delay distribution is estimated from different strata or as part of a separate estimate.</p>
</div>
<div class="section level3" number="2.4">
<h3 id="point-nowcast-from-delay-distribution-pid">
<span class="header-section-number">2.4</span> Point nowcast from delay distribution <span class="math inline">\(\pi(d)\)</span><a class="anchor" aria-label="anchor" href="#point-nowcast-from-delay-distribution-pid"></a>
</h3>
<p>To propagate the point nowcast from the delay distribution, we need to estimate the expected total number of eventual observed cases <span class="math inline">\(\hat{x}_t\)</span>, for each reference time <span class="math inline">\(t\)</span>.
Let <span class="math inline">\(z\)</span> be the sum over all delays <span class="math inline">\(d\)</span> that have already been observed (up until <span class="math inline">\(t^*-t\)</span>), such that <span class="math inline">\(z =\sum_{d=1}^{d=t^*-t} x_{t,d}\)</span> and <span class="math inline">\(\delta\)</span> be the cumulative sum of the delay distribution, <span class="math inline">\(\pi(d)\)</span> up until <span class="math inline">\(d = t^*-t\)</span> such that <span class="math inline">\(\delta = \sum_{d=1}^{d=t^*-t} \pi(d)\)</span>.
By assuming that <span class="math inline">\(z \sim Bin(x_t, \delta)\)</span> and <span class="math inline">\(x_t \sim Unif(0, \inf)\)</span>, it can be shown that the expected value of <span class="math inline">\(x_t\)</span>, the total number of reported cases on reference time <span class="math inline">\(t\)</span>, can be written as:</p>
<p><span class="math display">\[
E(x_t | z, \delta) = \hat{x}_t = \frac{z + 1 - \delta}{\delta}
\]</span></p>
<p>Then we can compute <span class="math inline">\(\hat{x}_{t,d}\)</span> directly using the <span class="math inline">\(d\)</span>th element of <span class="math inline">\(\pi(d)\)</span></p>
<p><span class="math display">\[
\hat{x}_{t,d} = \pi(d) \times \hat{x}_t
\]</span></p>
<p>Where the number of reports at timepoint <span class="math inline">\(t\)</span> with delay <span class="math inline">\(d\)</span> is the product of the the expected total reports, <span class="math inline">\(x_t\)</span> and the proportion expected at that particular delay <span class="math inline">\(d\)</span>, <span class="math inline">\(\pi(d)\)</span>.</p>
</div>
<div class="section level3" number="2.5">
<h3 id="estimate-of-uncertainty-in-the-nowcast">
<span class="header-section-number">2.5</span> Estimate of uncertainty in the nowcast<a class="anchor" aria-label="anchor" href="#estimate-of-uncertainty-in-the-nowcast"></a>
</h3>
<p>To extend these point nowcasts to probabilistic nowcasts, we use the past nowcast errors.
We describe a method which generates retrospective reporting triangles to replicate what would have been available as of time <span class="math inline">\(t^*=s^*\)</span>.</p>
<p>The method uses each retrospective incomplete reporting triangle to re-estimate a delay distribution using the <span class="math inline">\(N\)</span> preceding rows of the reporting triangle before <span class="math inline">\(s^*\)</span>, and recomputes a retrospective nowcast, for <span class="math inline">\(M\)</span> realizations of the retrospective reporting triangle (so <span class="math inline">\(M\)</span> different <span class="math inline">\(s^*\)</span> values).</p>
<p>For each horizon <span class="math inline">\(d = 1, ..., D\)</span> we assume that the observed values, <span class="math inline">\(X_{s^*-d, &gt;d}\)</span> follow a negative binomial observation model with a mean of <span class="math inline">\(\hat{x}_{s^*-d}\)</span>:</p>
<p><span class="math display">\[
X_{s^*-d,&gt;d} | \hat{x}_{s^*-d, &gt;d}(s*) \sim NegBin(\mu = \hat{x}_{s^*-d} + 0.1, \phi = \phi_d)
\]</span></p>
<p>We add a small number (0.1) to the mean to avoid an ill-defined negative binomial. We note that to perform all these computations, data snapshots from at least <span class="math inline">\(N + M\)</span> past observations, or rows of the reporting triangle, are needed. This estimate of the uncertainty accounts for the empirical uncertainty in the point estimate of the delay distribution over time.</p>
<div class="section level4" number="2.5.1">
<h4 id="generating-probabilistic-nowcasts">
<span class="header-section-number">2.5.1</span> Generating probabilistic nowcasts<a class="anchor" aria-label="anchor" href="#generating-probabilistic-nowcasts"></a>
</h4>
<p>Using the dispersion parameters for each delay, <span class="math inline">\(\phi(d)\)</span> for <span class="math inline">\(d = 1,...D\)</span>, we can generate probabilistic nowcasts by drawing samples from the negative binomial:</p>
<p><span class="math display">\[
X_{t,d} \sim NegBin(\mu = \hat{x}_{t,d}, \phi = \phi(d))
\]</span></p>
<p>We can sample for any number of draws, and then use the draws to compute any desired quantiles to summarize the outputs.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kaitlyn Johnson, <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>, Johannes Bracher, Sebastian Funk.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
