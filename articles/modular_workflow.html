<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Modular workflow demonstration • baselinenowcast</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Modular workflow demonstration">
<meta name="description" content="An example walking through the low-level function interface for specifying a nowcast model">
<meta property="og:description" content="An example walking through the low-level function interface for specifying a nowcast model">
<meta property="og:image" content="https://baselinenowcast.epinowcast.org/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">baselinenowcast</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.1000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/baselinenowcast.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/baselinenowcast.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/modular_workflow.html">Modular workflow demonstration</a></li>
    <li><a class="dropdown-item" href="../articles/model_definition.html">Mathematical model</a></li>
    <li><a class="dropdown-item" href="../articles/nomenclature.html">Nomenclature</a></li>
    <li><a class="dropdown-item" href="../articles/nssp_nowcast.html">A case study nowcasting applied to the U.S. National Syndromic Surveillance Program (NSSP) data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epinowcast/baselinenowcast/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Modular workflow demonstration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epinowcast/baselinenowcast/blob/main/vignettes/modular_workflow.Rmd" class="external-link"><code>vignettes/modular_workflow.Rmd</code></a></small>
      <div class="d-none name"><code>modular_workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>baselinenowcast</code> provides a set of methods, implemented as functions, to produce probabilistic estimates of the final observed cases from partially observed case counts.</p>
<p>Users can build a nowcast model in two ways:
1. Using the <code><a href="../reference/baselinenowcast.html">baselinenowcast()</a></code> wrapper function, which implements each step of the nowcasting workflow on one or more strata. See <code><a href="../reference/baselinenowcast.reporting_triangle.html">?baselinenowcast.reporting_triangle</a></code> and <code><a href="../reference/baselinenowcast.data.frame.html">?baselinenowcast.data.frame</a></code>, as well as the <a href="baselinenowcast.html">Getting Started</a> and <a href="nssp_nowcast.html">NSSP nowcasting</a> vignettes for examples of this workflow.
2. Using the low-level modular functions directly to allocate reference times for training, estimate a delay distribution, generate a point nowcast, estimate uncertainty, and sample from the observation model.</p>
<p>In this vignette, we will walk through the low-level implementation.
While the <code><a href="../reference/baselinenowcast.html">baselinenowcast()</a></code> wrapper function implements the most “common” nowcasting workflow with some options for specification, the modular workflow allows for maximum flexibility to compose a model of one’s choice via passing outputs from low-level functions in a pipeline-based approach.
We recommend this workflow for any users who wish to investigate and use intermediate outputs (e.g. the point nowcast matrix) and compose their own nowcasting workflow.</p>
<p>We will use the same dataset and problem from the <a href="baselinenowcast.html">Getting Started</a> vignette, and our assumption is that users have read that and are familiar with concepts introduced there such as the reporting triangle.
Also see the <a href="model_definition.html">model definition</a> vignette for more details on the mathematical methods, and the <a href="nomenclature.html">nomenclature</a> vignette for full descriptions of the terminology being used.</p>
</div>
<div class="section level2">
<h2 id="packages">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h2>
<p>As well as the <code>baselinenowcast</code> package this vignette also uses <code>ggplot2</code>, <code>tidyr</code>, and <code>dplyr</code>.
For <code>baselinenowcast</code>, see the <a href="https://github.com/epinowcast/baselinenowcast#installation" class="external-link">installation instructions</a>.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://baselinenowcast.epinowcast.org">baselinenowcast</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>Again, we will use the package data used in the <a href="baselinenowcast.html">Getting Started</a> vignette which contains COVID-19 cases in Germany by age group, indexed by the date of positive test and the date of report.</p>
<p>So that outputs are comparable, we will use the same specifications here.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_date</span> <span class="op">&lt;-</span> <span class="st">"2021-08-01"</span></span>
<span><span class="va">eval_date</span> <span class="op">&lt;-</span> <span class="st">"2021-10-01"</span></span>
<span></span>
<span><span class="va">target_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">germany_covid19_hosp</span>,</span>
<span>  <span class="va">location</span> <span class="op">==</span> <span class="st">"DE"</span>, <span class="va">age_group</span> <span class="op">==</span> <span class="st">"00+"</span>,</span>
<span>  <span class="va">report_date</span> <span class="op">&lt;=</span> <span class="va">eval_date</span>,</span>
<span>  <span class="va">reference_date</span> <span class="op">&lt;=</span> <span class="va">nowcast_date</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><p>The <code>latest_data</code> will be used for evaluation to compare our estimates of the final number of cases to the observed number of cases by reference date available as of October 1, 2021.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">latest_data</span> <span class="op">&lt;-</span> <span class="va">target_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>final_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><p>I am going to jump right into creating the dataset we need for nowcasting by filtering the data to exclude all report dates after the nowcast date, August 1, 2021.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">target_data</span>,</span>
<span>  <span class="va">report_date</span> <span class="op">&lt;=</span> <span class="va">nowcast_date</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span></code></pre></div>
</details><pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">##   reference_date location age_group delay count report_date</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> 2021-04-06     DE       00+           0   149 2021-04-06 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 2021-04-06     DE       00+           1   140 2021-04-07 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> 2021-04-06     DE       00+           2    61 2021-04-08 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> 2021-04-06     DE       00+           3    52 2021-04-09 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> 2021-04-06     DE       00+           4    36 2021-04-10 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> 2021-04-06     DE       00+           5     8 2021-04-11</span></span></code></pre>
<p>We refer to the “initial reports” as the sum of the cases at each reference date as they were available as of the nowcast date.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial_reports</span> <span class="op">&lt;-</span> <span class="va">observed_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>initial_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><p>Our task is to estimate, using the data available up until August 1, 2021, the “final” number of cases at each reference date.</p>
</div>
<div class="section level2">
<h2 id="model-specification">Model specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h2>
<p>We will specify the maximum delay.
We recommend choosing the maximum delay based on an exploratory data analysis of your specific dataset.
See the <a href="nssp_nowcast.html">NSSP nowcast</a> for an example</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_delay</span> <span class="op">&lt;-</span> <span class="fl">30</span></span></code></pre></div>
</details>
</div>
<div class="section level2">
<h2 id="pre-processing">Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing"></a>
</h2>
<p>We’ll start by generating a <code>reporting_triangle</code> object from the <code>observed_data</code> which contains incident case counts indexed by reference and report date.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_reporting_triangle.html">as_reporting_triangle</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span></span></code></pre></div>
</details><pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Using max_delay = 40 from data</span></span></code></pre>
<p>Let’s look at the reporting triangle we’ve created:</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri_full</span></span></code></pre></div>
</details><pre><code><span><span class="co">## <span style="font-weight: bold;">Reporting Triangle</span></span></span></code></pre>
<pre><code><span><span class="co">## Delays unit: days</span></span></code></pre>
<pre><code><span><span class="co">## Reference dates: 2021-04-06 to 2021-08-01</span></span></code></pre>
<pre><code><span><span class="co">## Max delay: 40</span></span></code></pre>
<pre><code><span><span class="co">## Structure: 1</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## Showing last 10 of 118 rows</span></span></code></pre>
<pre><code><span><span class="co">## Showing first 10 of 41 columns</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">##             0  1  2  3  4  5  6  7  8  9</span></span>
<span><span class="co">## 2021-07-23 30 12  4  1 10  6  0  2  2  1</span></span>
<span><span class="co">## 2021-07-24 31  8  4  9  8  2  5  2  1 NA</span></span>
<span><span class="co">## 2021-07-25  8  4 14  8  6  5  1  3 NA NA</span></span>
<span><span class="co">## 2021-07-26  9  6  2  3  0  0  0 NA NA NA</span></span>
<span><span class="co">## 2021-07-27 35 11  6  4  4  1 NA NA NA NA</span></span>
<span><span class="co">## 2021-07-28 51 28 25  3  5 NA NA NA NA NA</span></span>
<span><span class="co">## 2021-07-29 47 37  9  2 NA NA NA NA NA NA</span></span>
<span><span class="co">## 2021-07-30 36 20  2 NA NA NA NA NA NA NA</span></span>
<span><span class="co">## 2021-07-31 38 16 NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## 2021-08-01  7 NA NA NA NA NA NA NA NA NA</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## Use print(x, n_rows = NULL, n_cols = NULL) to see all data</span></span></code></pre>
<p>We can see the maximum delay inferred from the data.
For this analysis, we want to limit our reporting triangle to a maximum delay of 30 days:</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/truncate_to_delay.html">truncate_to_delay</a></span><span class="op">(</span><span class="va">rep_tri_full</span>, max_delay <span class="op">=</span> <span class="va">max_delay</span><span class="op">)</span></span></code></pre></div>
</details><pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Truncating from max_delay = 40 to 30.</span></span></code></pre>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri</span></span></code></pre></div>
</details><pre><code><span><span class="co">## <span style="font-weight: bold;">Reporting Triangle</span></span></span></code></pre>
<pre><code><span><span class="co">## Delays unit: days</span></span></code></pre>
<pre><code><span><span class="co">## Reference dates: 2021-04-06 to 2021-08-01</span></span></code></pre>
<pre><code><span><span class="co">## Max delay: 30</span></span></code></pre>
<pre><code><span><span class="co">## Structure: 1</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## Showing last 10 of 118 rows</span></span></code></pre>
<pre><code><span><span class="co">## Showing first 10 of 31 columns</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">##             0  1  2  3  4  5  6  7  8  9</span></span>
<span><span class="co">## 2021-07-23 30 12  4  1 10  6  0  2  2  1</span></span>
<span><span class="co">## 2021-07-24 31  8  4  9  8  2  5  2  1 NA</span></span>
<span><span class="co">## 2021-07-25  8  4 14  8  6  5  1  3 NA NA</span></span>
<span><span class="co">## 2021-07-26  9  6  2  3  0  0  0 NA NA NA</span></span>
<span><span class="co">## 2021-07-27 35 11  6  4  4  1 NA NA NA NA</span></span>
<span><span class="co">## 2021-07-28 51 28 25  3  5 NA NA NA NA NA</span></span>
<span><span class="co">## 2021-07-29 47 37  9  2 NA NA NA NA NA NA</span></span>
<span><span class="co">## 2021-07-30 36 20  2 NA NA NA NA NA NA NA</span></span>
<span><span class="co">## 2021-07-31 38 16 NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">## 2021-08-01  7 NA NA NA NA NA NA NA NA NA</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## Use print(x, n_rows = NULL, n_cols = NULL) to see all data</span></span></code></pre>
<p>We will use this <code>reporting_triangle</code> class object, <code>rep_tri</code>, for the remaining workflow steps.</p>
<p>In the modular workflow, we can specify the number of reference times used for delay and uncertainty estimation directly, or we can use the <code><a href="../reference/allocate_reference_times.html">allocate_reference_times()</a></code> function.
In this function, we specify the <code>scale_factor</code> which indicates the multiplicative factor on the maximum delay to determine the number of reference times for training the model, and the <code>prop_delay</code> which indicates what proportion of the reference times used for training are for delay estimation, with the remainder being used for uncertainty.</p>
<p>We will use the same values as are used by default in the <code><a href="../reference/allocate_reference_times.html">allocate_reference_times()</a></code> function, which is called internally within <code><a href="../reference/baselinenowcast.html">baselinenowcast()</a></code>.
See <code><a href="../reference/allocate_reference_times.html">?allocate_reference_times</a></code> for more details.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">prop_delay</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">tv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_reference_times.html">allocate_reference_times</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">rep_tri</span>,</span>
<span>  scale_factor <span class="op">=</span> <span class="va">scale_factor</span>,</span>
<span>  prop_delay <span class="op">=</span> <span class="va">prop_delay</span></span>
<span><span class="op">)</span></span>
<span><span class="va">n_history_delay</span> <span class="op">&lt;-</span> <span class="va">tv</span><span class="op">$</span><span class="va">n_history_delay</span></span>
<span><span class="va">n_retrospective_nowcasts</span> <span class="op">&lt;-</span> <span class="va">tv</span><span class="op">$</span><span class="va">n_retrospective_nowcasts</span></span></code></pre></div>
</details><p>Alternatively, if you wanted to directly specify the <code>n_history_delay</code> and <code>n_retrospective_nowcasts</code> directly, you could do this.
This might be useful if say you run your nowcast each week, but your data is daily, and you want to ensure that the number of weeks used for delay and uncertainty estimation is an integer number of weeks.</p>
</div>
<div class="section level2">
<h2 id="estimate-delay">Estimate delay<a class="anchor" aria-label="anchor" href="#estimate-delay"></a>
</h2>
<p>Now that we have the reporting triangle, we are now ready to estimate the delay distribution.
We will tell the function the maximum delay and the number of observations we want to use for estimation.
We only want to pass in the reporting triangle (for a single group!) to this function.
See documentation for <code><a href="../reference/estimate_delay.html">estimate_delay()</a></code> for a full description of the function inputs.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_pmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_delay.html">estimate_delay</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">rep_tri</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_history_delay</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><details><summary>
Click to expand code to create the plot of the delay distribution
</summary><details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  delay <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">delay_pmf</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_cdf_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Cumulative proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of cumulative proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># nolint</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_pmf_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">pmf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Proportion reported"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Empirical point estimate of proportion reported by delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details></details><details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_cdf_plot</span></span></code></pre></div>
</details><p><img src="modular_workflow_files/figure-html/unnamed-chunk-12-1.png"><!-- --></p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_pmf_plot</span></span></code></pre></div>
</details><p><img src="modular_workflow_files/figure-html/unnamed-chunk-12-2.png"><!-- -->
# Apply the delay to generate a point nowcast</p>
<p>The next step in our workflow is to take the estimated delay distribution and apply it to the partially observed reporting triangle, generating an estimate of the number of new cases confirmed at each reference date and delay.
This will generate a point estimate of complete the reporting matrix.
In this case, we will be applying the delay to the same reporting triangle we used to generate the estimate, but this doesn’t always have to be the case.
See the documentation for <code><a href="../reference/apply_delay.html">apply_delay()</a></code> for a full description of the input requirements.</p>
<p>It is worth noting that we could also have estimated the delay and applied it in one single step by calling <code><a href="../reference/fill_triangle.html">fill_triangle()</a></code>.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_nowcast_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_delay.html">apply_delay</a></span><span class="op">(</span></span>
<span>  reporting_triangle <span class="op">=</span> <span class="va">rep_tri</span>,</span>
<span>  delay_pmf <span class="op">=</span> <span class="va">delay_pmf</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><p>We’ll make a quick plot to compare our point estimate of the nowcasted confirmed cases through August 1, 2021, to the “final” observations from October 1, 2021 and to the right-truncated data available up until August 1, 2021.</p>
<details><summary>
Click to expand code to create the plot of the point nowcast
</summary><details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial_reports_labeled</span> <span class="op">&lt;-</span> <span class="va">initial_reports</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Initial real-time"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>count <span class="op">=</span> <span class="va">initial_count</span><span class="op">)</span></span>
<span><span class="va">point_nowcast_df</span> <span class="op">&lt;-</span> <span class="va">latest_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>count <span class="op">=</span> <span class="va">final_count</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>nowcast <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">point_nowcast_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">count</span>, <span class="va">nowcast</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"count"</span> <span class="op">~</span> <span class="st">"Final observed data"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"nowcast"</span> <span class="op">~</span> <span class="st">"Point nowcast"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">type</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">initial_reports_labeled</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot with data type as a variable</span></span>
<span><span class="va">plot_pt_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">point_nowcast_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>  y <span class="op">=</span> <span class="va">count</span>,</span>
<span>  color <span class="op">=</span> <span class="va">type</span></span>
<span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Initial reports"</span> <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>    <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    <span class="st">"Point nowcast"</span> <span class="op">=</span> <span class="st">"darkblue"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Confirmed admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparing initial reports, nowcasted, and later observed cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Type"</span><span class="op">)</span></span></code></pre></div>
</details></details><details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_pt_nowcast</span></span></code></pre></div>
</details><p><img src="modular_workflow_files/figure-html/unnamed-chunk-15-1.png"><!-- -->
Here we can see that our point nowcast (blue) slightly underestimates what was eventually reported (black), but does a decent overall job of correcting for the right-truncation observed in the the data as of the nowcast date (red).</p>
</div>
<div class="section level2">
<h2 id="estimate-uncertainty">Estimate uncertainty<a class="anchor" aria-label="anchor" href="#estimate-uncertainty"></a>
</h2>
<p>So far, we’ve demonstrated how to generate a point estimate of a nowcast.
We would like to generate probabilistic nowcasts.</p>
<p>We’ll do so by estimating uncertainty using past nowcast errors.</p>
<p>We repeat this process for <code>n_retrospective_nowcasts</code> reference times in the current reporting triangle, starting from the latest reference time and working backwards, ultimately using all <code>n_retrospective_nowcasts</code> and <code>n_history_delay</code> reference times.</p>
<p>We’ll start by creating a list of truncated triangles using the <code><a href="../reference/truncate_triangles.html">truncate_triangles()</a></code> function which successively removes an addition additional reference time from the original reporting triangle <code>n</code> times.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trunc_rep_tri_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/truncate_triangles.html">truncate_triangles</a></span><span class="op">(</span></span>
<span>  <span class="va">rep_tri</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_retrospective_nowcasts</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><p>For each truncated triangle, we will use the <code><a href="../reference/apply_reporting_structures.html">apply_reporting_structures()</a></code> function to generate what would have been available as of the latest reference time within each truncated triangle.
We refer to these as retrospective reporting triangles.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">retro_rep_tri_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/apply_reporting_structures.html">apply_reporting_structures</a></span><span class="op">(</span><span class="va">trunc_rep_tri_list</span><span class="op">)</span></span></code></pre></div>
</details><p>Next we will pass this list of reporting triangles to the <code><a href="../reference/fill_triangles.html">fill_triangles()</a></code> and specify <code>n</code>, the number of reference times to be used to estimate the delay for each nowcast, which we will set as the <code>n_history_delay</code> previous specified.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">retro_pt_nowcast_mat_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fill_triangles.html">fill_triangles</a></span><span class="op">(</span></span>
<span>  retro_reporting_triangles <span class="op">=</span> <span class="va">retro_rep_tri_list</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_history_delay</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><p>This function will generate a list of point nowcast matrices using the delay estimated from each retrospective reporting triangle.</p>
<p>Next, we will use the retrospective reporting triangles, the point nowcast matrices, and the truncated reporting triangles to estimate the uncertainty at each horizon, starting at horizon 0 using the <code><a href="../reference/estimate_uncertainty.html">estimate_uncertainty()</a></code> function.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disp_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_uncertainty.html">estimate_uncertainty</a></span><span class="op">(</span></span>
<span>  point_nowcast_matrices <span class="op">=</span> <span class="va">retro_pt_nowcast_mat_list</span>,</span>
<span>  truncated_reporting_triangles <span class="op">=</span> <span class="va">trunc_rep_tri_list</span>,</span>
<span>  retro_reporting_triangles <span class="op">=</span> <span class="va">retro_rep_tri_list</span>,</span>
<span>  n <span class="op">=</span> <span class="va">n_retrospective_nowcasts</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><p>T
his function uses a negative binomial observation model by default, and independently estimates the dispersion in the negative binomial at each forecast horizon.</p>
<p>Note that the estimation of uncertainty from a reporting triangle can be done in a single step using the <code><a href="../reference/estimate_uncertainty_retro.html">estimate_uncertainty_retro()</a></code> function, which chains together the truncation of triangles, construction of retrospective reporting triangles, the generation of point nowcasts via filling the triangles, and the estimation of the uncertainty from the estimates compared to the observations.</p>
</div>
<div class="section level2">
<h2 id="generate-probabilistic-nowcast">Generate probabilistic nowcast<a class="anchor" aria-label="anchor" href="#generate-probabilistic-nowcast"></a>
</h2>
<p>Now that we have estimated the dispersion, we can generate a probabilistic nowcast using the <code><a href="../reference/sample_nowcasts.html">sample_nowcasts()</a></code> function which:</p>
<ul>
<li>generates draws from the nowcast distribution</li>
<li>combines the draws with the observed data to form a single draw of the nowcast</li>
<li>repeats this process for <code>draws</code> draws</li>
</ul>
<p>Note that from a point nowcast and a reporting triangle, one could also estimate and apply uncertainty using the <code><a href="../reference/estimate_and_apply_uncertainty.html">estimate_and_apply_uncertainty()</a></code> function.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_draws_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_nowcasts.html">sample_nowcasts</a></span><span class="op">(</span></span>
<span>  <span class="va">point_nowcast_matrix</span>,</span>
<span>  <span class="va">rep_tri</span>,</span>
<span>  uncertainty_params <span class="op">=</span> <span class="va">disp_params</span>,</span>
<span>  draws <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcast_draws_df</span><span class="op">)</span></span></code></pre></div>
</details><pre><code><span><span class="co">##   pred_count reference_date draw</span></span>
<span><span class="co">## 1        609     2021-04-06    1</span></span>
<span><span class="co">## 2       1024     2021-04-07    1</span></span>
<span><span class="co">## 3       1352     2021-04-08    1</span></span>
<span><span class="co">## 4       1195     2021-04-09    1</span></span>
<span><span class="co">## 5       1113     2021-04-10    1</span></span>
<span><span class="co">## 6        773     2021-04-11    1</span></span></code></pre>
<p>See documentation for <code><a href="../reference/sample_nowcasts.html">sample_nowcasts()</a></code>for further details.</p>
</div>
<div class="section level2">
<h2 id="visualizing-the-nowcast">Visualizing the nowcast<a class="anchor" aria-label="anchor" href="#visualizing-the-nowcast"></a>
</h2>
<p>Let’s visualize the nowcast compared to the final observed data.
We first need to join our nowcast with the original data so we can see our nowcast by reference date.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_with_nowcast_draws_df</span> <span class="op">&lt;-</span> <span class="va">nowcast_draws_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">latest_data</span>, by <span class="op">=</span> <span class="st">"reference_date"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">initial_reports</span>, by <span class="op">=</span> <span class="st">"reference_date"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs_with_nowcast_draws_df</span><span class="op">)</span></span></code></pre></div>
</details><pre><code><span><span class="co">##   pred_count reference_date draw final_count initial_count</span></span>
<span><span class="co">## 1        609     2021-04-06    1         615           615</span></span>
<span><span class="co">## 2       1024     2021-04-07    1        1036          1036</span></span>
<span><span class="co">## 3       1352     2021-04-08    1        1384          1384</span></span>
<span><span class="co">## 4       1195     2021-04-09    1        1232          1232</span></span>
<span><span class="co">## 5       1113     2021-04-10    1        1137          1137</span></span>
<span><span class="co">## 6        773     2021-04-11    1         794           794</span></span></code></pre>
<p>Create a separate dataframe for only the observed and final data, to make plotting easier.</p>
<details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="va">obs_with_nowcast_draws_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">reference_date</span>, <span class="va">initial_count</span>, <span class="va">final_count</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">initial_count</span>, <span class="va">final_count</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"initial_count"</span> <span class="op">~</span> <span class="st">"Initial reports"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"final_count"</span> <span class="op">~</span> <span class="st">"Final observed data"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><details><summary>
Click to expand code to create the plot of the probabilistic nowcast
</summary><details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="va">obs_with_nowcast_draws_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">reference_date</span>, <span class="va">initial_count</span>, <span class="va">final_count</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">initial_count</span>, <span class="va">final_count</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"initial_count"</span> <span class="op">~</span> <span class="st">"Initial reports"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"final_count"</span> <span class="op">~</span> <span class="st">"Final observed data"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with draws for nowcast only</span></span>
<span><span class="va">plot_prob_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add nowcast draws as thin gray lines</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">obs_with_nowcast_draws_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">pred_count</span>, group <span class="op">=</span> <span class="va">draw</span>,</span>
<span>      color <span class="op">=</span> <span class="st">"Nowcast draw"</span>, linewidth <span class="op">=</span> <span class="st">"Nowcast draw"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add observed data and final data once</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">combined_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">count</span>,</span>
<span>      color <span class="op">=</span> <span class="va">type</span>,</span>
<span>      linewidth <span class="op">=</span> <span class="va">type</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Nowcast draw"</span> <span class="op">=</span> <span class="st">"gray"</span>,</span>
<span>      <span class="st">"Initial reports"</span> <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>      <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"black"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linewidth_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Nowcast draw"</span> <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>      <span class="st">"Initial reports"</span> <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Reference date"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hospital admissions"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparison of admissions as of the nowcast date, later observed counts, \n and probabilistic nowcasted counts"</span><span class="op">)</span> <span class="co"># nolint</span></span></code></pre></div>
</details></details><details class="chunk-details" open><summary class="chunk-summary"><span class="chunk-summary-text">Code</span></summary><div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_prob_nowcast</span></span></code></pre></div>
</details><p><img src="modular_workflow_files/figure-html/unnamed-chunk-24-1.png"><!-- -->
Gray lines indicate the probabilistic nowcast draws, which are a combination of the already observed data at each reference date and the predicted nowcast draws at each reference date.
Black lines show the “final” data from October 1, 2021.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>In this vignette we used the <code>baselinenowcast</code> low-level modular functions to convert a dataframe with incident cases indexed by reference date and report date to a <code>reporting_triangle</code> object using the <code>as_reporting_triangle</code> function, and then walked through the <code>baselinenowcast</code> workflow step by step. This involved:
1. <code><a href="../reference/estimate_delay.html">estimate_delay()</a></code> - Estimating a delay
2. <code><a href="../reference/apply_delay.html">apply_delay()</a></code> - Generating a point nowcast matrix
3. <code><a href="../reference/truncate_triangles.html">truncate_triangles()</a></code> - Truncating triangles at iteratively earlier retrospective nowcast times
4. <code><a href="../reference/apply_reporting_structures.html">apply_reporting_structures()</a></code> - Constructing retrospective reporting triangles based on what would have been available as of the nowcast date.
5. <code><a href="../reference/fill_triangles.html">fill_triangles()</a></code> - Generating point nowcasts from the retrospective reporting triangles
6. <code><a href="../reference/estimate_uncertainty.html">estimate_uncertainty()</a></code> - Estimating uncertainty from retrospective point nowcast matrices and eventual observations.
7. <code><a href="../reference/sample_nowcasts.html">sample_nowcasts()</a></code> - Sampling from the observation model to generate probabilistic nowcasts</p>
<p>This modular workflow allows for maximum flexibility and the ability to interrogate intermediate steps.
The idea is that from these component functions, a wide range of <code>baselinenowcast</code> models can be developed via a pipeline-based approach where the outputs of one function are passed to the inputs of another function, or the inputs of one function can for example be swapped with an external estimate.</p>
<p>This vignette walks through and produces the same results as in the <a href="baselinenowcast.html">Getting Started</a> vignette, which uses the package default settings to specify the model.
However, the optimal settings will depend on the context and its important to tune the model to your dataset and needs.
In our <a href="https://wellcomeopenresearch.org/articles/10-614/v1" class="external-link">publication</a> we show examples using the various model specifications to produce and evaluate the performance of age-group specific nowcasts of COVID-19 in Germany and norovirus cases in England.
Here’s a <a href="https://github.com/epinowcast/baselinenowcast-paper" class="external-link">link</a> to the code used to generate those nowcasts if interested in doing something similar for your own settings.</p>
<p>We encourage users to test the performance of different specifications of their model, ideally by producing nowcasts from different model specifications for a range of past nowcast dates, using the data that would have been available as of the past nowcast date, and comparing those nowcasts to later observed data.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kaitlyn Johnson, Emily Tyszka, Johannes Bracher, Sebastian Funk, <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
