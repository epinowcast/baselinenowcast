<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Nowcasting syndromic surveillance system data: a case study applied to the U.S. National Syndromic Surveillance Program (NSSP) data • baselinenowcast</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Nowcasting syndromic surveillance system data: a case study applied to the U.S. National Syndromic Surveillance Program (NSSP) data">
<meta name="description" content="A nowcasting example applied to data from NSSP">
<meta property="og:description" content="A nowcasting example applied to data from NSSP">
<meta property="og:image" content="https://baselinenowcast.epinowcast.org/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">baselinenowcast</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/baselinenowcast.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/baselinenowcast.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/modular_workflow.html">Modular workflow demonstration</a></li>
    <li><a class="dropdown-item" href="../articles/model_definition.html">Mathematical model</a></li>
    <li><a class="dropdown-item" href="../articles/nomenclature.html">Nomenclature</a></li>
    <li><a class="dropdown-item" href="../articles/nssp_nowcast.html">A case study nowcasting applied to the U.S. National Syndromic Surveillance Program (NSSP) data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/epinowcast/baselinenowcast/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Nowcasting syndromic surveillance system data: a case study applied to the U.S. National Syndromic Surveillance Program (NSSP) data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epinowcast/baselinenowcast/blob/main/vignettes/nssp_nowcast.Rmd" class="external-link"><code>vignettes/nssp_nowcast.Rmd</code></a></small>
      <div class="d-none name"><code>nssp_nowcast.Rmd</code></div>
    </div>

    
    
<div class="section level2" number="1">
<h2 id="introduction">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Syndromic surveillance data are used by public health departments to understand trends in clinical encounters from electronic health records.
When these datasets are analysed in real-time, delays from the initial visit to updated diagnoses codes results in systematic downward bias in the counts of the primary event, i.e. the patient visit, due to the most recent dates being only partially observed.
Nowcasting uses historical reporting delays to correct for this downward bias and estimate the eventual, final observed cases, which provides an estimate of the trend in cases in real-time.
In this vignette, we will pre-process the timestamped data captured in each NSSP ESSENCE visit record to obtain data in the format we need for nowcasting, and then we will demonstrate how to specify and run the <code>baselinenowcast</code> workflow.
Lastly, we’ll summarise the nowcast and plot against the later observed data.</p>
<div class="section level3" number="1.1">
<h3 id="about-syndromic-surveillance-system-data">
<span class="header-section-number">1.1</span> About syndromic surveillance system data<a class="anchor" aria-label="anchor" href="#about-syndromic-surveillance-system-data"></a>
</h3>
<p>Syndromic surveillance system data contains information at the visit-level on the timing and nature of the patient’s clinical interactions.
In this case study, we will use synthetic data from the United States’ <a href="https://www.cdc.gov/nssp/index.html" class="external-link">National Syndromic Surveillance Program</a> (NSSP) dataset available for participating jurisdictions through the Centers for Disease Control and Prevention’s (CDC) ESSENCE platform, to nowcast cases of Broad Acute Respiratory Incidence (BAR) defined by a set of diagnoses codes.
These could easily be swapped out with another set of diagnoses codes e.g. for influenza-like illness, COVID-19, etc.
The NSSP Emergency Department (ED) visit dataset is a dataset widely used by public health departments in the United States, representing many but not all counties in the country.
The dataset contains information at the visit-level about each clinical encounter recorded in the electronic health record system during the patient’s hospital stay.
Clinical encounters may begin to be associated with diagnoses codes at different points in the patient or clinical processing journey (e.g. during registration, triage, clinical encounter, after laboratory results are returned, or during coding for billing, etc.), and are captured through update messages to the syndromic surveillance system once they are entered into a facility’s electronic health record.
The difference between the visit date - when the patient registers in the emergency department- and the time of the diagnosis update pertaining to the diagnosis of interest, is used to compute a reporting delay for each patient.
Reporting delays for diagnoses of interest can vary by a range of factors including by pathogen/syndrome, season, time of day or week, means of diagnosis, the electronic health record system, or treating facility.
Note that all visits that originate in the emergency department are used for this analysis, regardless of eventual inpatient admission.</p>
</div>
<div class="section level3" number="1.2">
<h3 id="load-packages">
<span class="header-section-number">1.2</span> Load packages<a class="anchor" aria-label="anchor" href="#load-packages"></a>
</h3>
<p>We use the <code>baselinenowcast</code> package for nowcasting, <code>dplyr</code>, and <code>tidyr</code> for data manipulation, <code>stringr</code> for parsing text data, <code>lubridate</code> for formatting dates, <code>ggplot2</code> for plotting, and <code>purrr</code> for mapping diagnoses codes to text fields in the data.
For <code>baselinenowcast</code>, see the <a href="https://github.com/epinowcast/baselinenowcast#installation" class="external-link">installation instructions</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span></span>
<span>  collapse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"#&gt;"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/epinowcast/baselinenowcast" class="external-link">baselinenowcast</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="2">
<h2 id="nssp-data-pre-processing">
<span class="header-section-number">2</span> NSSP data pre-processing<a class="anchor" aria-label="anchor" href="#nssp-data-pre-processing"></a>
</h2>
<p>We will walk through how to preprocess the line list NSSP data details dataset in order to obtain a <a href="https://r4ds.had.co.nz/tidy-data.html" class="external-link">long tidy dataframe</a> containing the incident counts of “cases” of a particular syndrome by reference date (in this instance the date the visit started) and report date (the date the patient’s record was updated with the corresponding diagnosis of interest).
We need the data in this format to estimate the reporting delay, which we will then apply to the partial observations to produce a nowcast – an estimate of the final observed cases.</p>
<div class="section level3" number="2.1">
<h3 id="load-in-the-line-list-data">
<span class="header-section-number">2.1</span> Load in the line list data<a class="anchor" aria-label="anchor" href="#load-in-the-line-list-data"></a>
</h3>
<p>This typically will be pulled using an API, but here we provide the <code>syn_nssp_line_list</code> dataset as package data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">syn_nssp_line_list</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 25 × 8</span></span></span>
<span><span class="co">#&gt;    C_Processed_BioSense_ID        CCDDParsed              DischargeDiagnosisMD…¹</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2024.02.03.23961E_2353110519   COUGH SENT BY UC | ;U0… {1};2024-02-03 13:45:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2024.02.04.23970E_8016495577   COUGH COVID | ;U071;    {1};2024-02-04 10:29:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2024.02.09.6146E_MM20716469698 VOMITING NAUSEA | ;U07… {1};2024-02-09 01:50:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2024.02.08.23960I_3453027660   DIVERTICULITIS | ;R197… {1};2024-02-08 19:05:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2024.02.02.6170E_HF221066059   PREGNANT COLD SYMPTOMS… {1};2024-02-02 01:15:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2024.02.09.6148I_230936904054  NAUSEU WEAK BACK PAIN … {1};2024-02-09 16:01:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2024.02.04.6139I_107268480     SHORTNESS OF BREATH | … {1};2024-02-04 09:17:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2024.02.09.6131E_MP009028546   FLU LIKE SYMPTOMS | ;U… {1};2024-02-09 13:30:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2024.02.03.30901E_15694614     SHORTNESS OF BREATH | … {1};2024-02-03 06:57:…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2024.02.05.23956E_315489587    FOOT PAIN FOOT INJURY … {1};2024-02-05 05:49:…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 15 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​DischargeDiagnosisMDTUpdates</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: DischargeDiagnosisUpdates &lt;chr&gt;, HasBeenAdmitted &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   C_Visit_Date_Time &lt;dttm&gt;, c_race &lt;chr&gt;, sex &lt;chr&gt;</span></span></span></code></pre></div>
<div class="alert alert-warning" role="alert">
<p><strong>Note:</strong> This dataset does not represent data from real patients, it is entirely synthetic and designed to mirror the NSSP update fields, which records the timing of a clinical encounter and the corresponding diagnoses code, if any. See <code><a href="../reference/syn_nssp_line_list.html">?syn_nssp_line_list</a></code> for full documentation.</p>
</div>
</div>
<div class="section level3" number="2.2">
<h3 id="define-the-syndrome-definition">
<span class="header-section-number">2.2</span> Define the “syndrome” definition<a class="anchor" aria-label="anchor" href="#define-the-syndrome-definition"></a>
</h3>
<p>In this near-real-time emergency department dataset, we use public health surveillance definitions, or “syndrome” definitions.
These syndrome definitions exist for a range of public health concerns and are primarily defined by the CDC’s NSSP Community of Practice, who consult subject matter experts from public health departments.
They definitions typically rely on the presence of diagnosis code(s), specific free text captured in clinical notes, or a combination of these.
In some instances, exclusion criteria are incorporated into these definitions to improve their specificity.</p>
<p>Here we will list the diagnosis codes which correspond to Broad Acute Respiratory, but any sets of diagnosis codes that define a syndrome could be used interchangeably.
To be considered a Broad Acute Respiratory case, one or more of these codes must be reported.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagnoses_codes_defn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A22.1"</span>, <span class="st">"A221"</span>, <span class="st">"A37"</span>, <span class="st">"A48.1"</span>, <span class="st">"A481"</span>, <span class="st">"B25.0"</span>, <span class="st">"B250"</span>, <span class="st">"B34.2"</span>, <span class="st">"B34.9"</span>, <span class="st">"B342"</span>, <span class="st">"B349"</span>, <span class="st">"B44.0"</span>, <span class="st">"B44.9"</span>, <span class="st">"B440"</span>, <span class="st">"B449"</span>, <span class="st">"B44.81"</span>, <span class="st">"B4481"</span>, <span class="st">"B97.2"</span>, <span class="st">"B97.4"</span>, <span class="st">"B972"</span>, <span class="st">"B974"</span>, <span class="st">"J00"</span>, <span class="st">"J01"</span>, <span class="st">"J02"</span>, <span class="st">"J03"</span>, <span class="st">"J04"</span>, <span class="st">"J05"</span>, <span class="st">"J06"</span>, <span class="st">"J09"</span>, <span class="st">"J10"</span>, <span class="st">"J11"</span>, <span class="st">"J12"</span>, <span class="st">"J13"</span>, <span class="st">"J14"</span>, <span class="st">"J15"</span>, <span class="st">"J16"</span>, <span class="st">"J17"</span>, <span class="st">"J18"</span>, <span class="st">"J20"</span>, <span class="st">"J21"</span>, <span class="st">"J22"</span>, <span class="st">"J39.8"</span>, <span class="st">"J398"</span>, <span class="st">"J40"</span>, <span class="st">"J47.9"</span>, <span class="st">"J479"</span>, <span class="st">"J80"</span>, <span class="st">"J85.1"</span>, <span class="st">"J851"</span>, <span class="st">"J95.821"</span>, <span class="st">"J95821"</span>, <span class="st">"J96.0"</span>, <span class="st">"J96.00"</span>, <span class="st">"J9600"</span>, <span class="st">"J96.01"</span>, <span class="st">"J9601"</span>, <span class="st">"J96.02"</span>, <span class="st">"J9602"</span>, <span class="st">"J96.2"</span>, <span class="st">"J960"</span>, <span class="st">"J962"</span>, <span class="st">"J96.20"</span>, <span class="st">"J9620"</span>, <span class="st">"J96.21"</span>, <span class="st">"J9621"</span>, <span class="st">"J9622"</span>, <span class="st">"J96.22"</span>, <span class="st">"J96.91"</span>, <span class="st">"J9691"</span>, <span class="st">"J98.8"</span>, <span class="st">"J988"</span>, <span class="st">"R05"</span>, <span class="st">"R06.03"</span>, <span class="st">"R0603"</span>, <span class="st">"R09.02"</span>, <span class="st">"R0902"</span>, <span class="st">"R09.2"</span>, <span class="st">"R092"</span>, <span class="st">"R43.0"</span>, <span class="st">"R43.1"</span>, <span class="st">"R43.2"</span>, <span class="st">"R430"</span>, <span class="st">"R431"</span>, <span class="st">"R432"</span>, <span class="st">"U07.1"</span>, <span class="st">"U07.2"</span>, <span class="st">"U071"</span>, <span class="st">"U072"</span>, <span class="st">"022.1"</span>, <span class="st">"0221"</span>, <span class="st">"034.0"</span>, <span class="st">"0340"</span>, <span class="st">"041.5"</span>, <span class="st">"0415"</span>, <span class="st">"041.81"</span>, <span class="st">"04181"</span>, <span class="st">"079.1"</span>, <span class="st">"079.2"</span>, <span class="st">"079.3"</span>, <span class="st">"079.6"</span>, <span class="st">"0791"</span>, <span class="st">"0792"</span>, <span class="st">"0793"</span>, <span class="st">"0796"</span>, <span class="st">"079.82"</span>, <span class="st">"079.89"</span>, <span class="st">"07982"</span>, <span class="st">"07989"</span>, <span class="st">"079.99"</span>, <span class="st">"07999"</span>, <span class="st">"117.3"</span>, <span class="st">"1173"</span>, <span class="st">"460"</span>, <span class="st">"461"</span>, <span class="st">"462"</span>, <span class="st">"463"</span>, <span class="st">"464"</span>, <span class="st">"465"</span>, <span class="st">"466"</span>, <span class="st">"461."</span>, <span class="st">"461"</span>, <span class="st">"461."</span>, <span class="st">"464."</span>, <span class="st">"465."</span>, <span class="st">"466."</span>, <span class="st">"461"</span>, <span class="st">"464"</span>, <span class="st">"465"</span>, <span class="st">"466"</span>, <span class="st">"478.9"</span>, <span class="st">"4789"</span>, <span class="st">"480."</span>, <span class="st">"482."</span>, <span class="st">"483."</span>, <span class="st">"484."</span>, <span class="st">"487."</span>, <span class="st">"488."</span>, <span class="st">"480"</span>, <span class="st">"481"</span>, <span class="st">"482"</span>, <span class="st">"483"</span>, <span class="st">"484"</span>, <span class="st">"485"</span>, <span class="st">"486"</span>, <span class="st">"487"</span>, <span class="st">"488"</span>, <span class="st">"490"</span>, <span class="st">"494.1"</span>, <span class="st">"4941"</span>, <span class="st">"517.1"</span>, <span class="st">"5171"</span>, <span class="st">"518.51"</span>, <span class="st">"518.53"</span>, <span class="st">"51851"</span>, <span class="st">"51853"</span>, <span class="st">"518.6"</span>, <span class="st">"5186"</span>, <span class="st">"518.81"</span>, <span class="st">"518.82"</span>, <span class="st">"518.84"</span>, <span class="st">"51881"</span>, <span class="st">"51882"</span>, <span class="st">"51884"</span>, <span class="st">"519.8"</span>, <span class="st">"5198"</span>, <span class="st">"073.0"</span>, <span class="st">"0730"</span>, <span class="st">"781.1"</span>, <span class="st">"7811"</span>, <span class="st">"786.2"</span>, <span class="st">"7862"</span>, <span class="st">"799.02"</span>, <span class="st">"79902"</span>, <span class="st">"799.1"</span>, <span class="st">"7991"</span>, <span class="st">"033"</span>, <span class="st">"033."</span>, <span class="st">"033"</span>, <span class="st">"780.60"</span>, <span class="st">"78060"</span><span class="op">)</span> <span class="co"># nolint</span></span></code></pre></div>
</div>
<div class="section level3" number="2.3">
<h3 id="expand-the-data-so-that-each-event-has-its-own-column">
<span class="header-section-number">2.3</span> Expand the data so that each “event” has its own column<a class="anchor" aria-label="anchor" href="#expand-the-data-so-that-each-event-has-its-own-column"></a>
</h3>
<p>First we will pivot the line-list’s time stamp and diagnosis update columns into a long format with one row per update.</p>
<p>We will create two datasets which parse the characters in the columns <code>DischargeDiagnosisMDTUpdates</code> and <code>DischargeDiagnosisUpdates</code> , which contain a string listing the time stamp and diagnosis codes (respectively) of each “event” in the clinical encounter, formatted as:</p>
<ul>
<li><p><code>{event number};YYYY-MM-DD HH:MM:SS;|{event number 2};YYYY-MM-DD HH:MM:SS;|</code> for <code>DischargeDiagnosisMDTUpdates</code></p></li>
<li><p><code>{event number};{diagnoses codes};|{event number 2}{diagnoses codes};|</code> for <code>DischargeDiagnosisUpdates</code></p></li>
</ul>
<p>The timestamp records the timing of diagnosis code updates related to each clinical encounter, capturing the point in time when each new code became available within the NSSP system.
Later, we will merge the two datasets back together by the unique patient ID and the event number, so that we can associate each set of diagnoses codes with a timestamp.</p>
<p>We will use <code><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html" class="external-link">tidyr::separate_wider_delim()</a></code> to expand these entries, so that each “event” has its own column.
Since patients experience a different number of patient update “events”, there will be missing values for patients not experiencing many events during their visit.
The columns will be named by the original column name + the event number, e.g. <code>DischargeDiagnosisMDTUpdates1</code>.
We’ll write a function to do this for both the time stamps and diagnoses codes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">expand_events</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">line_list</span>, <span class="va">event_col_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">wide_line_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html" class="external-link">separate_wider_delim</a></span><span class="op">(</span><span class="va">line_list</span>,</span>
<span>    <span class="op">{</span><span class="op">{</span> <span class="va">event_col_name</span> <span class="op">}</span><span class="op">}</span>,</span>
<span>    delim <span class="op">=</span> <span class="st">"{"</span>, names_sep <span class="op">=</span> <span class="st">""</span>, too_few <span class="op">=</span> <span class="st">"align_start"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">wide_line_list</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Expand both the time stamps and diagnoses codes, and remove the column containing the information on the other.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">syn_nssp_time_stamps_wide</span> <span class="op">&lt;-</span> <span class="fu">expand_events</span><span class="op">(</span></span>
<span>  line_list <span class="op">=</span> <span class="va">syn_nssp_line_list</span>,</span>
<span>  event_col_name <span class="op">=</span> <span class="st">"DischargeDiagnosisMDTUpdates"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">DischargeDiagnosisUpdates</span><span class="op">)</span></span>
<span></span>
<span><span class="va">syn_nssp_diagnoses_wide</span> <span class="op">&lt;-</span> <span class="fu">expand_events</span><span class="op">(</span></span>
<span>  line_list <span class="op">=</span> <span class="va">syn_nssp_line_list</span>,</span>
<span>  event_col_name <span class="op">=</span> <span class="st">"DischargeDiagnosisUpdates"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">DischargeDiagnosisMDTUpdates</span><span class="op">)</span></span></code></pre></div>
<p>We will write a function that, for each of the diagnoses and time stamps datasets, find the name of the last update column, and uses that to pivot the data from wide to long.
This creates a long tidy dataframe where each row is now an event.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wide_to_long</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">wide_line_list</span>,</span>
<span>                         <span class="va">event_col_name</span>,</span>
<span>                         <span class="va">values_to</span>,</span>
<span>                         <span class="va">names_to</span>,</span>
<span>                         <span class="va">id_col_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">long_data</span> <span class="op">&lt;-</span> <span class="va">wide_line_list</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">event_col_name</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="op">{</span><span class="op">{</span> <span class="va">names_to</span> <span class="op">}</span><span class="op">}</span>,</span>
<span>      values_to <span class="op">=</span> <span class="op">{</span><span class="op">{</span> <span class="va">values_to</span> <span class="op">}</span><span class="op">}</span>,</span>
<span>      values_drop_na <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      event_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>        <span class="va">.data</span><span class="op">[[</span><span class="va">id_col_name</span><span class="op">]</span><span class="op">]</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">.data</span><span class="op">[[</span><span class="va">names_to</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"[0-9.]+"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">long_data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Pivot both datasets from long to wide using the function above, specifying the name of the column which will hold the values (either time stamps or diagnoses).
We will create a unique event ID using the event number and the patient ID (<code>id_col_name</code>) which in this case is the <code>C_Processed_BioSense_ID</code> column.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">syn_nssp_time_stamps_long</span> <span class="op">&lt;-</span> <span class="fu">wide_to_long</span><span class="op">(</span></span>
<span>  wide_line_list <span class="op">=</span> <span class="va">syn_nssp_time_stamps_wide</span>,</span>
<span>  event_col_name <span class="op">=</span> <span class="st">"DischargeDiagnosisMDTUpdates"</span>,</span>
<span>  values_to <span class="op">=</span> <span class="st">"time_stamp"</span>,</span>
<span>  names_to <span class="op">=</span> <span class="st">"column_name"</span>,</span>
<span>  id_col_name <span class="op">=</span> <span class="st">"C_Processed_BioSense_ID"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">syn_nssp_diagnoses_long</span> <span class="op">&lt;-</span> <span class="fu">wide_to_long</span><span class="op">(</span></span>
<span>  wide_line_list <span class="op">=</span> <span class="va">syn_nssp_diagnoses_wide</span>,</span>
<span>  event_col_name <span class="op">=</span> <span class="st">"DischargeDiagnosisUpdates"</span>,</span>
<span>  values_to <span class="op">=</span> <span class="st">"diagnoses_codes"</span>,</span>
<span>  names_to <span class="op">=</span> <span class="st">"column_name"</span>,</span>
<span>  id_col_name <span class="op">=</span> <span class="st">"C_Processed_BioSense_ID"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we will clean up the time stamps in the data so that the <code>time_stamp</code> column is formatted as <code>%Y-%m-%d %H:%M:%S</code>, format the visit time the same (<code>C_Visit_Date_Time</code>) and then we will filter out an events that are not present (updates are NAs).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">syn_nssp_time_stamps</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">syn_nssp_time_stamps_long</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    time_stamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">time_stamp</span>, <span class="st">".*\\}"</span><span class="op">)</span>,</span>
<span>        <span class="st">"[|;]+"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      format <span class="op">=</span> <span class="st">"%Y-%m-%d %H:%M:%S"</span>,</span>
<span>      tz <span class="op">=</span> <span class="st">"UTC"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    C_Visit_Date_Time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">C_Visit_Date_Time</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">time_stamp</span><span class="op">)</span></span></code></pre></div>
<p>Clean up the diagnoses codes and remove the empty updates from the diagnoses dataset.
For these, we want to keep the semi-colons and just remove the numbers since
this information is stored in the event ID.
We will only use the event ID and the diagnoses codes, as this will be merged
back into the time stamped dataset.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">syn_nssp_diagnoses</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">syn_nssp_diagnoses_long</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>diagnoses_codes <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove</a></span><span class="op">(</span><span class="va">diagnoses_codes</span>, <span class="st">".*\\}"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">diagnoses_codes</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">event_id</span>, <span class="va">diagnoses_codes</span><span class="op">)</span></span></code></pre></div>
<p>Merge together the time stamps of events and the diagnoses codes.
Filter to remove empty updates.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nssp_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">syn_nssp_time_stamps</span>,</span>
<span>  <span class="va">syn_nssp_diagnoses</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"event_id"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">diagnoses_codes</span> <span class="op">!=</span> <span class="st">";;|"</span><span class="op">)</span></span></code></pre></div>
<p>Now we have a dataframe where each row is an event, with the patient’s visit start date (<code>C_Visit_date_Time</code>), the patient ID (<code>C_Processed_BioSense_ID</code>), the diagnoses code at the event (<code>diagnoses_code</code>), and the time stamp of the event (<code>time_stamp</code>).
Next we will add a column for the time from arrival to each updated diagnosis, in days.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nssp_updates</span> <span class="op">&lt;-</span> <span class="va">nssp_merged</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>arrival_to_update_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span></span>
<span>    <span class="va">time_stamp</span>, <span class="va">C_Visit_Date_Time</span>,</span>
<span>    units <span class="op">=</span> <span class="st">"days"</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We next filter through the updates to find the first “hit” that corresponds to the diagnosis codes in the syndromic surveillance definition for BAR.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bar_updates</span> <span class="op">&lt;-</span> <span class="va">nssp_updates</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_lgl</a></span><span class="op">(</span><span class="va">diagnoses_codes</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">diagnoses_codes_defn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will order these by the delay from visit to the diagnoses, and for each patient keep only the first update containing the BAR diagnoses code(s).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">first_bar_diagnosis</span> <span class="op">&lt;-</span> <span class="va">bar_updates</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">arrival_to_update_delay</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">C_Processed_BioSense_ID</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Label the visit start date, <code>C_Visit_Date_Time</code>, as the reference date,<code>reference_date</code> and <code>time_stamp</code> as the report date, <code>report_date</code> and remove the other column names that are no longer needed, as each row now represents a case.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clean_line_list</span> <span class="op">&lt;-</span> <span class="va">first_bar_diagnosis</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    reference_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">C_Visit_Date_Time</span><span class="op">)</span>,</span>
<span>    report_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">time_stamp</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">clean_line_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 13</span></span></span>
<span><span class="co">#&gt;   event_id C_Processed_BioSense…¹ CCDDParsed HasBeenAdmitted C_Visit_Date_Time  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2024.02… 2024.02.01.23959I_204… ABNORMAL …               1 2024-02-01 <span style="color: #949494;">13:30:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2024.02… 2024.02.01.23965V_656… DIFFICULT…               1 2024-02-01 <span style="color: #949494;">09:26:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2024.02… 2024.02.01.24119E_H10… COUGH FEV…               1 2024-02-01 <span style="color: #949494;">13:25:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2024.02… 2024.02.01.24167I_065… LETHARGY …               1 2024-02-01 <span style="color: #949494;">11:15:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2024.02… 2024.02.01.6132E_2260… COVID LAS…               0 2024-02-01 <span style="color: #949494;">13:36:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2024.02… 2024.02.01.6133I_2490… HIGH BLLO…               1 2024-02-01 <span style="color: #949494;">11:04:00</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated name: ¹​C_Processed_BioSense_ID</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 8 more variables: c_race &lt;chr&gt;, sex &lt;chr&gt;, column_name &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   time_stamp &lt;dttm&gt;, diagnoses_codes &lt;chr&gt;, arrival_to_update_delay &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   reference_date &lt;date&gt;, report_date &lt;date&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3" number="2.4">
<h3 id="obtain-counts-of-cases-by-reference-date-visit-date-and-report-date-time-of-first-diagnosis">
<span class="header-section-number">2.4</span> Obtain counts of cases by reference date (visit date) and report date (time of first diagnosis)<a class="anchor" aria-label="anchor" href="#obtain-counts-of-cases-by-reference-date-visit-date-and-report-date-time-of-first-diagnosis"></a>
</h3>
<p>For nowcasting, we want to compute the number of incident cases indexed by reference and report date, so we can aggregate by reference and report date and compute the delay distribution.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count_df_raw</span> <span class="op">&lt;-</span> <span class="va">clean_line_list</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span>, <span class="va">report_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">report_date</span> <span class="op">-</span> <span class="va">reference_date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'reference_date'. You can override using</span></span>
<span><span class="co">#&gt; the `.groups` argument.</span></span></code></pre></div>
<p>Looking at this data, we can see that there is one case where there is a negative delay, which indicates that the time stamp of the diagnosis update was recorded before the start of the visit.
Depending on the way that the data is generated, this could be a true negative value, for example if the patient had previously been tested elsewhere before arriving at the ED.
In this case, patients interactions with the system always start in the ED, so this is likely due to a data entry error.
For this reason, we will will choose to exclude all the negative valued delays, however, the choice of how to handle these should be guided be guided by the data experts and their understanding of the most likely reason for the observation to prevent introducing additional bias in this choice.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">count_df_raw</span>, <span class="va">delay</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">count_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   reference_date [3]</span></span></span>
<span><span class="co">#&gt;   reference_date report_date count delay</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2024-02-01     2024-02-01      4     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2024-02-01     2024-02-02      1     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2024-02-01     2024-02-20      1    19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2024-02-02     2024-02-05      1     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2024-02-02     2024-02-10      1     8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2024-02-03     2024-02-03      1     0</span></span></code></pre></div>
<p>We have now generated data in the format that we need to use the <code>baselinenowcast</code> package, which requires a <a href="https://r4ds.had.co.nz/tidy-data.html" class="external-link">long tidy dataframe</a> with incident case counts indexed by reference date and report date.
See the <a href="baselinenowcast.html">Getting Started</a> and <a href="model_definition.html">model definition</a> vignettes for more details on the data format we need for nowcasting.
For demonstration purposes, we will now swap out the data from the simulated NSSP line-list data with a larger synthetic dataset.
In reality you would proceed straight from this dataset to the subsequent steps, using the case counts indexed by reference date and report date to run the nowcasting workflow.</p>
</div>
</div>
<div class="section level2" number="3">
<h2 id="pre-processing-of-larger-synthetic-dataset">
<span class="header-section-number">3</span> Pre-processing of larger synthetic dataset<a class="anchor" aria-label="anchor" href="#pre-processing-of-larger-synthetic-dataset"></a>
</h2>
<p>We’ll start by loading in the synthetic reporting triangle dataframe, which is also provided as package data.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">syn_nssp_df</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3,795 × 3</span></span></span>
<span><span class="co">#&gt;    reference_date report_date count</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 2025-10-25     2025-10-25    194</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 2025-10-25     2025-10-26     54</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2025-10-25     2025-10-27     26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 2025-10-25     2025-10-28     13</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 2025-10-25     2025-10-29     12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 2025-10-25     2025-10-30     13</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 2025-10-25     2025-10-31      5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 2025-10-25     2025-11-04     14</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 2025-10-25     2025-11-05      9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 2025-10-25     2025-11-06     14</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3,785 more rows</span></span></span></code></pre></div>
<div class="alert alert-warning" role="alert">
<p><strong>Note:</strong> This dataset represents synthetic data on the number of incident cases indexed by reference date and report date. It was generated to approximately mirror trends in BAR cases during a season without using any real data. See <code><a href="../reference/syn_nssp_df.html">?syn_nssp_df</a></code> for full documentation.</p>
</div>
<p>You can see that this larger synthetic dataset has the same format as the one we generated from the line list NSSP data – with columns for reference date, report date, and counts.</p>
<div class="section level3" number="3.1">
<h3 id="exploratory-data-analysis-to-identify-an-appropriate-maximum-delay">
<span class="header-section-number">3.1</span> Exploratory data analysis to identify an appropriate maximum delay<a class="anchor" aria-label="anchor" href="#exploratory-data-analysis-to-identify-an-appropriate-maximum-delay"></a>
</h3>
To produce a nowcast with <code>baselinenowcast</code>, we will first want to perform an exploratory data analysis to visualize trends in the delay distribution.
This will help us choose a maximum delay and specify the number of reference times we want to use for delay and uncertainty estimation.
<details><summary>
Click to expand code to create plots of the delay distributions
</summary><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">long_df</span> <span class="op">&lt;-</span> <span class="va">syn_nssp_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">report_date</span> <span class="op">-</span> <span class="va">reference_date</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_df_t</span> <span class="op">&lt;-</span> <span class="va">long_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span> <span class="op">*</span> <span class="va">delay</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_summary</span> <span class="op">&lt;-</span> <span class="va">long_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean_delay_overall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span> <span class="op">*</span> <span class="va">delay</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">avg_delays</span> <span class="op">&lt;-</span> <span class="va">long_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>pmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">long_df</span><span class="op">$</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cdf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">pmf</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">delay_df_t</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>    y <span class="op">=</span> <span class="va">mean_delay</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">delay_summary</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">mean_delay_overall</span></span>
<span>    <span class="op">)</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Mean delay"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdf_delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">avg_delays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span>, y <span class="op">=</span> <span class="va">cdf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdf_delay</span></span></code></pre></div>
<p><img src="nssp_nowcast_files/figure-html/unnamed-chunk-18-1.png" alt="" width="672"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delay_t</span></span></code></pre></div>
<p><img src="nssp_nowcast_files/figure-html/unnamed-chunk-18-2.png" alt="" width="672"></p>
<p>Based on this figure, we can set the maximum delay to be 25 days as this is where 95% of the cases appear to have been reported.
In general, we want to choose a maximum delay that will incorporate the vast majority of all observed reporting delays so that the estimates of the final counts account for all eventual cases reported.
However, a longer maximum delay will mean that you will require more historical data for training the model, which must be considered if the amount of historical data is limited say in a novel outbreak situation.
In order to produce a nowcast that we can evaluate against later observed data for this example, we will pretend that we are making a nowcast 30 days before the last reference date in the dataset, May 5th, 2026.
In real-time, we would just use the latest reference date as our nowcast date, however, for evaluating the performance of the method we want to look back at the nowcast we would have made with the data we would have had at past time points.
See the <a href="baselinenowcast.html">Getting Started</a> vignette for another example of evaluating our nowcast, and for a full quantitative evaluation of the method applied to different case studies, see our <a href="https://www.medrxiv.org/content/10.1101/2025.08.14.25333653v2" class="external-link">pre-print</a> where we evaluate the method on COVID-19 cases in Germany and norovirus cases in England.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_delay</span> <span class="op">&lt;-</span> <span class="fl">25</span></span>
<span><span class="va">nowcast_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">long_df</span><span class="op">$</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3" number="3.2">
<h3 id="format-for-baselinenowcast">
<span class="header-section-number">3.2</span> Format for <code>baselinenowcast</code><a class="anchor" aria-label="anchor" href="#format-for-baselinenowcast"></a>
</h3>
<p>First, we’ll remove any reports after the nowcast date, as these wouldn’t have been available to us in real-time.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>  <span class="va">long_df</span>,</span>
<span>  <span class="va">report_date</span> <span class="op">&lt;=</span> <span class="va">nowcast_date</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>What would happen if we looked at the trend in case counts without correcting for downward bias due to partial observations?
We can summarise the cases by reference dates and plot.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">training_df_by_ref_date</span> <span class="op">&lt;-</span> <span class="va">training_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">report_date</span> <span class="op">&lt;=</span> <span class="va">nowcast_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>initial_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<details><summary>
Click to expand code to create the plot of the initially reported cases
</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">init_data</span> <span class="op">&lt;-</span> <span class="va">training_df_by_ref_date</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reference_date</span> <span class="op">&gt;=</span> <span class="va">nowcast_date</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_inits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">init_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">initial_count</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Initially reported BAR cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Date of ED visit"</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_inits</span></span></code></pre></div>
<p><img src="nssp_nowcast_files/figure-html/unnamed-chunk-23-1.png" alt="" width="672"></p>
<p>We can see that without nowcasting, the cases appear to be sharply declining at the most recent dates.
We can’t tell from this data alone if the true trend in cases is really declining rapidly or if it is plateauing or increasing, which is why we need to use nowcasting to make an estimate of the eventually reported cases at each visit date.</p>
<p>From here, we have the case counts by reference and report date up until the nowcast date.
We will generate a reporting triangle (see the <a href="model_definition.html">mathematical model</a> vignette for more details), using the helper function <code><a href="../reference/as_reporting_triangle.html">as_reporting_triangle()</a></code>.
This helper function fills in all combinations of reference dates and delays and pivots the data from long to wide to obtain a reporting triangle where rows are reference dates and columns are delays.
This is returned as a <code>reporting_triangle</code> class object which is ready to be used for nowcasting.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_reporting_triangle.html">as_reporting_triangle</a></span><span class="op">(</span><span class="va">training_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Using max_delay = 154 from data</span></span></code></pre></div>
<p>Let’s look at the reporting triangle object we’ve created:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri_full</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Reporting Triangle</span></span></span>
<span><span class="co">#&gt; Delays unit: days</span></span>
<span><span class="co">#&gt; Reference dates: 2025-10-25 to 2026-04-01</span></span>
<span><span class="co">#&gt; Max delay: 154</span></span>
<span><span class="co">#&gt; Structure: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Showing last 10 of 159 rows</span></span>
<span><span class="co">#&gt; Showing first 10 of 155 columns</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              0   1  2  3  4  5  6  7  8  9</span></span>
<span><span class="co">#&gt; 2026-03-23 210 131 34 50 35 12  1 25 20  6</span></span>
<span><span class="co">#&gt; 2026-03-24 221  96 22 10 13  6  0  5  9 NA</span></span>
<span><span class="co">#&gt; 2026-03-25 291 129 17 26 42 29 23 25 NA NA</span></span>
<span><span class="co">#&gt; 2026-03-26 179  96 22 50  9  8 18 NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-27 284  40 41 54 28 12 NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-28 217  78 46 14 39 NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-29 336 161 62 13 NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-30 296  53 55 NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-31 210 108 NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-04-01 236  NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use print(x, n_rows = NULL, n_cols = NULL) to see all data</span></span></code></pre></div>
<p>And we can get a summary of it:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rep_tri_full</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Reporting Triangle Summary</span></span></span>
<span><span class="co">#&gt; Dimensions: 159 x 155</span></span>
<span><span class="co">#&gt; Reference period: 2025-10-25 to 2026-04-01</span></span>
<span><span class="co">#&gt; Max delay: 154 days</span></span>
<span><span class="co">#&gt; Structure: 1</span></span>
<span><span class="co">#&gt; Most recent complete date: 2025-10-29 (442 cases)</span></span>
<span><span class="co">#&gt; Dates requiring nowcast: 154 (complete: 5)</span></span>
<span><span class="co">#&gt; Rows with negatives: 0</span></span>
<span><span class="co">#&gt; Zeros: 9905 (77.9% of non-NA values)</span></span>
<span><span class="co">#&gt; Zeros per row summary:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     0.0    18.5    63.0    62.3   100.5   145.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Mean delay summary (complete rows):</span></span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   3.615   4.298   4.416   4.414   4.679   5.059</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">99% quantile delay (complete rows):</span></span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;    22.0    31.0    31.0    33.4    34.0    49.0</span></span></code></pre></div>
<p>We can see the maximum delay inferred from the data.
For this analysis, we want to limit our reporting triangle to a maximum delay of 25 days using <code><a href="../reference/truncate_to_delay.html">truncate_to_delay()</a></code>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/truncate_to_delay.html">truncate_to_delay</a></span><span class="op">(</span><span class="va">rep_tri_full</span>, max_delay <span class="op">=</span> <span class="va">max_delay</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Truncating from max_delay = 154 to 25.</span></span></code></pre></div>
<p>Let’s check the truncated triangle:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rep_tri</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Reporting Triangle</span></span></span>
<span><span class="co">#&gt; Delays unit: days</span></span>
<span><span class="co">#&gt; Reference dates: 2025-10-25 to 2026-04-01</span></span>
<span><span class="co">#&gt; Max delay: 25</span></span>
<span><span class="co">#&gt; Structure: 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Showing last 10 of 159 rows</span></span>
<span><span class="co">#&gt; Showing first 10 of 26 columns</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              0   1  2  3  4  5  6  7  8  9</span></span>
<span><span class="co">#&gt; 2026-03-23 210 131 34 50 35 12  1 25 20  6</span></span>
<span><span class="co">#&gt; 2026-03-24 221  96 22 10 13  6  0  5  9 NA</span></span>
<span><span class="co">#&gt; 2026-03-25 291 129 17 26 42 29 23 25 NA NA</span></span>
<span><span class="co">#&gt; 2026-03-26 179  96 22 50  9  8 18 NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-27 284  40 41 54 28 12 NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-28 217  78 46 14 39 NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-29 336 161 62 13 NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-30 296  53 55 NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-03-31 210 108 NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; 2026-04-01 236  NA NA NA NA NA NA NA NA NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use print(x, n_rows = NULL, n_cols = NULL) to see all data</span></span></code></pre></div>
</div>
<div class="section level3" number="3.3">
<h3 id="specify-the-baselinenowcast-model">
<span class="header-section-number">3.3</span> Specify the <code>baselinenowcast</code> model<a class="anchor" aria-label="anchor" href="#specify-the-baselinenowcast-model"></a>
</h3>
<p>Next, we’ll specify the number of reference times used for delay and uncertainty estimation as a factor of the maximum delay.
We’ll also specify the proportion of reference times which will be used for delay estimation, with the remaining used for estimating uncertainty.
We’ll set these as the default values, but in a real-world setting we recommend performing an evaluation analysis to identify the optimal amount of training data to be used for each of these tasks.
See the documentation for <code><a href="../reference/allocate_reference_times.html">?allocate_reference_times</a></code> and the “Default Settings” section of the <a href="model_definition.html">mathematical model</a> vignette for more details.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">prop_delay</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span></code></pre></div>
<p>Internally, we will call <code><a href="../reference/allocate_reference_times.html">allocate_reference_times()</a></code> which uses the reporting triangle matrix and these specifications to allocate the number of reference times used for delay and uncertainty given the number of reference times available and the maximum delay.
Since our maximum delay is 25 days, this function will allocate 25*3 (75) reference times for fitting the model, with about half of them (37) being used for delay estimation and the other half (38) used for uncertainty estimation.</p>
</div>
</div>
<div class="section level2" number="4">
<h2 id="run-the-baselinenowcast-workflow">
<span class="header-section-number">4</span> Run the <code>baselinenowcast</code> workflow<a class="anchor" aria-label="anchor" href="#run-the-baselinenowcast-workflow"></a>
</h2>
<p>To produce a nowcast, we can use the <code><a href="../reference/baselinenowcast.html">baselinenowcast()</a></code> function to generate an estimate of the “final” number of cases of BAR by reference date.
This function chains together the <code>baselinenowcast</code> workflow,
It handles allocating reference times for training (<code><a href="../reference/allocate_reference_times.html">allocate_reference_times()</a></code>), estimating a delay (<code><a href="../reference/estimate_delay.html">estimate_delay()</a></code>), generating a point nowcast (<code><a href="../reference/apply_delay.html">apply_delay()</a></code>), and estimating and applying uncertainty (<code><a href="../reference/estimate_and_apply_uncertainty.html">estimate_and_apply_uncertainty()</a></code>), while also managing required bookkeeping to return nowcasts by reference dates.
See <code><a href="../reference/baselinenowcast.reporting_triangle.html">?baselinenowcast.reporting_triangle</a></code> for more details on each step in the workflow, and check out the <a href="model_definition.html">mathematical_model</a> for details on the mathematical model used for each component.
The <code><a href="../reference/baselinenowcast.html">baselinenowcast()</a></code> function can ingest either a reporting triangle object as we made above, or a data.frame with cases by reference and report date for one or strata with support for common workflows such as sharing estimates across strata.
See <code><a href="../reference/baselinenowcast.data.frame.html">?baselinenowcast.data.frame</a></code> for more details.</p>
<p>By default, the <code>output_type = "samples"</code> which means that it will estimate and apply uncertainty using past nowcast errors to generate probabilistic nowcast draws.
Point nowcasts can also be generated by specifying <code>output_type = "point"</code>.
It will by default produce 1000 draws, but this can be specified as more or less using the <code>draws</code> argument.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_draws_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/baselinenowcast.html">baselinenowcast</a></span><span class="op">(</span><span class="va">rep_tri</span>,</span>
<span>  scale_factor <span class="op">=</span> <span class="va">scale_factor</span>,</span>
<span>  prop_delay <span class="op">=</span> <span class="va">prop_delay</span>,</span>
<span>  draws <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> 0.5 reference times were specified for delay estimation but 0.493 of reference times used for delay estimation.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `prop_delay` not identical to the proportion of reference times used for delay estimation due to rounding.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcast_draws_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;     pred_count reference_date draw output_type</span></span>
<span><span class="co">#&gt; 1          382     2025-10-25    1     samples</span></span>
<span><span class="co">#&gt; 160        382     2025-10-25    2     samples</span></span>
<span><span class="co">#&gt; 319        382     2025-10-25    3     samples</span></span>
<span><span class="co">#&gt; 478        382     2025-10-25    4     samples</span></span>
<span><span class="co">#&gt; 637        382     2025-10-25    5     samples</span></span>
<span><span class="co">#&gt; 796        382     2025-10-25    6     samples</span></span></code></pre></div>
<p>Because we specified training volumes that did not result in integer reference times, we’ll get a message letting us know that 37/75, or 0.493 of the reference times are being used for delay estimation.</p>
</div>
<div class="section level2" number="5">
<h2 id="summarise-and-plot-the-nowcast">
<span class="header-section-number">5</span> Summarise and plot the nowcast<a class="anchor" aria-label="anchor" href="#summarise-and-plot-the-nowcast"></a>
</h2>
<p>We now have an estimate of the “final” number of cases of BAR by reference date with uncertainty.
To summarise the uncertainty, we can compute prediction intervals.
Here we will visualize the results using the 50th and 95th percent prediction intervals, though we suggest showing more prediction intervals if possible.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_summary_df</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">nowcast_draws_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">pred_count</span><span class="op">)</span>,</span>
<span>    q50th_lb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">pred_count</span>, <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>    q50th_ub <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">pred_count</span>, <span class="fl">0.75</span><span class="op">)</span>,</span>
<span>    q95th_lb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">pred_count</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>    q95th_ub <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">pred_count</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>In order to compare our estimates to the data that was available as of the time of the nowcast and the “final” cases (which is what we were trying to estimate), we will join both the initially reported cases and the held out, true final cases to our probabilistic nowcasts.
We already summarised the initial reports by reference date from the data used to train the nowcast model.
Next summarise the final reports by reference date using all the data.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eval_data</span> <span class="op">&lt;-</span> <span class="va">long_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="va">delay</span> <span class="op">&lt;=</span> <span class="va">max_delay</span>,</span>
<span>    <span class="va">reference_date</span> <span class="op">&lt;=</span> <span class="va">nowcast_date</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">reference_date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>final_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Lastly, join the initial and final reports to the probabilistic nowcast.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nowcast_w_data</span> <span class="op">&lt;-</span> <span class="va">nowcast_summary_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">training_df_by_ref_date</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"reference_date"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">eval_data</span>,</span>
<span>    by <span class="op">=</span> <span class="st">"reference_date"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcast_w_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;   reference_date median q50th_lb q50th_ub q95th_lb q95th_ub initial_count</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2025-10-25        382      382      382      382      382           402</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2025-10-26        432      432      432      432      432           439</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2025-10-27        351      351      351      351      351           363</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2025-10-28        361      361      361      361      361           364</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2025-10-29        426      426      426      426      426           442</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2025-10-30        362      362      362      362      362           367</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: final_count &lt;dbl&gt;</span></span></span></code></pre></div>
<div class="section level3" number="5.1">
<h3 id="plot-nowcast-against-later-observed-final-data">
<span class="header-section-number">5.1</span> Plot nowcast against later observed “final” data<a class="anchor" aria-label="anchor" href="#plot-nowcast-against-later-observed-final-data"></a>
</h3>
<p>Next we will make a plot of the nowcasted “final” cases compared to the initially reported cases and the true “final” reports.
The plot shows that, had we naively summarised the initial reports by reference date (red), it would have appeared as if the recent cases of BAR were declining rapidly.
With our probabilistic nowcast (gray), we can see an estimate of the true trend in real-time, which shows that the cases of BAR are plateauing rather than continuing to decline.
Compared to what we eventually observe (black), we can see that our nowcasts appear visually to have been relatively accurate.
For more quantitative evaluation, we recommend using proper scoring rules (e.g. using the <a href="https://epiforecasts.io/scoringutils/" class="external-link"><code>scoringutils</code> R package</a>) to evaluate nowcasts.</p>
<details><summary>
Click to expand code to create the plot of the probabilistic nowcast
</summary><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="va">nowcast_w_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">reference_date</span>, <span class="va">initial_count</span>, <span class="va">final_count</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">initial_count</span>, <span class="va">final_count</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"type"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"count"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"initial_count"</span> <span class="op">~</span> <span class="st">"Initially observed data"</span>,</span>
<span>    <span class="va">type</span> <span class="op">==</span> <span class="st">"final_count"</span> <span class="op">~</span> <span class="st">"Final observed data"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reference_date</span> <span class="op">&gt;=</span> <span class="va">nowcast_date</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nowcast_data_recent</span> <span class="op">&lt;-</span> <span class="va">nowcast_w_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">reference_date</span> <span class="op">&gt;=</span> <span class="va">nowcast_date</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_prob_nowcast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nowcast_data_recent</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>, y <span class="op">=</span> <span class="va">median</span></span>
<span>    <span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"gray"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>      ymin <span class="op">=</span> <span class="va">q50th_lb</span>, ymax <span class="op">=</span> <span class="va">q50th_ub</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"gray"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>      ymin <span class="op">=</span> <span class="va">q95th_lb</span>, ymax <span class="op">=</span> <span class="va">q95th_ub</span></span>
<span>    <span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"gray"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add observed data and final data once</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">combined_data</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">reference_date</span>,</span>
<span>      y <span class="op">=</span> <span class="va">count</span>,</span>
<span>      color <span class="op">=</span> <span class="va">type</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"Initially observed data"</span> <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>      <span class="st">"Final observed data"</span> <span class="op">=</span> <span class="st">"black"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">""</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Date of ED visit"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Number of BAR cases"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Comparison of cases of BAR as of the nowcast date, later observed,\n and generated as a probabilistic nowcast"</span><span class="op">)</span> <span class="co"># nolint</span></span></code></pre></div>
</details><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_prob_nowcast</span></span></code></pre></div>
<p><img src="nssp_nowcast_files/figure-html/unnamed-chunk-35-1.png" alt="" width="672"></p>
</div>
</div>
<div class="section level2" number="6">
<h2 id="summary">
<span class="header-section-number">6</span> Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>In this vignette we used <code>baselinenowcast</code> to nowcast cases of BAR starting from synthetic syndromic surveillance system data designed to mirror the U.S. NSSP dataset.
We walked through the process of defining a syndromic surveillance definition using a list of diagnoses codes, and using the time stamps of updates in an electronic health record in the NSSP dataset to create a count of the number of cases of a specific definition indexed by the date of their visit and the date at which the patient’s diagnoses was recorded into the surveillance system.
From there we converted the data to a <code>reporting_triangle</code> object and then ran the <code>baselinenowcast</code> workflow using the <code><a href="../reference/baselinenowcast.html">baselinenowcast()</a></code> function to generate probabilistic nowcasts.
This function chains together multiple steps, and we describe the modular workflow option in the <a href="baselinenowcst.html">Getting Started</a> vignette.
As a final step, we compared our nowcasts of the eventual final observed case counts to what we later observed and the right-truncated initial reports.</p>
<p>Next steps include scoring the nowcasts we generated using proper scoring rules such as the weighted interval score (WIS) or the continuous ranked probability score (CRPS) and computing metrics such as the interval coverage to assess how well the observed data falls within our uncertainty bands.
See the <a href="epiforecasts.io/scoringutils/"><code>scoringutils</code> R package</a> for resources on scoring predictions.
In this vignette we used the package’s default settings to specify the model, but the optimal settings will be dependent on the context and its important to tune the model for your dataset and needs.
The user has a number of choices in how to specify the model, such as the amount of training data to use for delay or uncertainty estimation, the choice of observation model, whether to separately estimate delays by weekday, or whether to borrow estimates from across different strata such as age groups or locations.
See the <a href="baselinenowcast.html">Getting Started</a> vignette and <a href="model_definition.html">model definition</a> for more details on the different model specifications.
In our <a href="https://wellcomeopenresearch.org/articles/10-614/v1" class="external-link">publication</a> we show examples using the various model specifications to produce and evaluate the performance of age-group specific nowcasts of COVID-19 in Germany and norovirus cases in England.
Here’s a <a href="https://github.com/epinowcast/baselinenowcast-paper" class="external-link">link</a> to the code used to generate those nowcasts if interested in doing something similar for your own settings.</p>
<p>Visual inspection of the nowcasts produced, as well as visual inspection of the data such as the mean reporting delay over time and across weekdays, can help identify which specifications are most likely to improve performance.
We encourage users to test the performance of different specifications of their model, ideally by producing nowcasts from different model specifications for a range of past nowcast dates, using the data that would have been available as of the past nowcast date, and comparing those nowcasts to later observed data.
You could do this just as we did here when we filtered the long tidy data.frame indexed by reference and report date, to remove report dates before the nowcast date.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kaitlyn Johnson, Emily Tyszka, Johannes Bracher, Sebastian Funk, <a href="https://www.samabbott.co.uk/" class="external-link">Sam Abbott</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
