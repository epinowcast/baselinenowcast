% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/estimate_and_apply_uncertainty.R
\name{estimate_and_apply_uncertainty}
\alias{estimate_and_apply_uncertainty}
\title{Estimate and apply uncertainty to a point nowcast matrix}
\usage{
estimate_and_apply_uncertainty(
  point_nowcast_matrix,
  reporting_triangle,
  n_history_delay,
  n_retrospective_nowcasts,
  max_delay = ncol(reporting_triangle) - 1,
  draws = 1000,
  structure = 1,
  uncertainty_model = fit_by_horizon,
  uncertainty_sampler = sample_nb,
  ...
)
}
\arguments{
\item{point_nowcast_matrix}{Matrix of point nowcast predictions and
observations, with rows representing the reference times and columns
representing the delays.}

\item{reporting_triangle}{Matrix of the reporting triangle, with rows
representing the time points of reference and columns representing the
delays. Can be a reporting matrix or incomplete reporting matrix.
Can also be a ragged reporting triangle, where multiple columns are
reported for the same row. (e.g. weekly reporting of daily data).}

\item{n_history_delay}{Integer indicating the number of reference times
(observations) to be used in the estimate of the reporting delay, always
starting from the most recent reporting delay.}

\item{n_retrospective_nowcasts}{Integer indicating the number of
retrospective nowcast times to use for uncertainty estimation.}

\item{max_delay}{Integer indicating the maximum delay to estimate, in units
of the delay. The default is to use the whole reporting triangle,
\code{ncol(reporting_triangle) -1}.}

\item{draws}{Integer indicating the number of draws of the predicted
nowcast vector to generate. Default is \code{1000}.}

\item{structure}{Integer or vector specifying the reporting structure.
If integer, divides columns evenly by that integer (with last possibly
truncated).  If vector, the sum must not be greater than or equal to the
number of columns. Default is 1 (standard triangular structure).}

\item{uncertainty_model}{Function that ingests a matrix of observations and a
matrix of predictions and returns a vector that can be used to
apply uncertainty using the same error model. Default is
\code{fit_by_horizon} with arguments of \code{obs} matrix of observations and
\code{pred} the matrix of predictions that fits each column (horizon)
to a negative binomial observation model by default. The user can
specify a different fitting model by replacing the
\code{fit_model} argument in \code{fit_by_horizon}.}

\item{...}{Additional arguments to \code{\link[=estimate_uncertainty_retro]{estimate_uncertainty_retro()}} and
\code{\link[=sample_nowcasts]{sample_nowcasts()}}.}
}
\value{
\code{nowcast_draws_df} Dataframe containing draws of combined
observations and probabilistic predictions at each reference time.
}
\description{
Generates probabilistic nowcasts by estimating uncertainty parameters from
retrospective nowcasts and applying them to a point nowcast matrix.

This function combines:
\enumerate{
\item \code{\link[=estimate_uncertainty_retro]{estimate_uncertainty_retro()}} - Estimates uncertainty parameters
using retrospective nowcasts
\item \code{\link[=sample_nowcasts]{sample_nowcasts()}} - Applies uncertainty to generate draws
}

For uncertainty estimation without sampling, use
\code{\link[=estimate_uncertainty_retro]{estimate_uncertainty_retro()}}. For full control over individual steps
(e.g., custom matrix preparation, alternative aggregation), use the
low-level functions (\code{\link[=truncate_triangles]{truncate_triangles()}}, \code{\link[=construct_triangles]{construct_triangles()}},
\code{\link[=fill_triangles]{fill_triangles()}}, \code{\link[=estimate_uncertainty]{estimate_uncertainty()}}) directly.
}
\examples{
triangle <- matrix(
  c(
    40, 10, 20, 5,
    80, 50, 25, 10,
    100, 50, 30, 20,
    90, 45, 25, NA,
    80, 40, NA, NA,
    70, NA, NA, NA
  ),
  nrow = 6,
  byrow = TRUE
)
pt_nowcast_matrix <- estimate_and_apply_delay(
  reporting_triangle = triangle,
  n = 4
)
# Need to tell uncertainty estimator to also use 4 reference times for
# delay estimation, the remaining 2 will then be used for
# uncertainty estimation.
nowcast_draws_df <- estimate_and_apply_uncertainty(
  pt_nowcast_matrix,
  triangle,
  n_history_delay = 4,
  n_retrospective_nowcasts = 2
)
nowcast_draws_df
}
